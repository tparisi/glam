var COMPILED=!0,goog=goog||{};goog.global=this;goog.DEBUG=!0;goog.LOCALE="en";goog.provide=function(a){if(!COMPILED){if(goog.isProvided_(a))throw Error('Namespace "'+a+'" already declared.');delete goog.implicitNamespaces_[a];for(var b=a;(b=b.substring(0,b.lastIndexOf(".")))&&!goog.getObjectByName(b);)goog.implicitNamespaces_[b]=!0}goog.exportPath_(a)};goog.setTestOnly=function(a){if(COMPILED&&!goog.DEBUG)throw a=a||"",Error("Importing test-only code into non-debug environment"+a?": "+a:".");};
COMPILED||(goog.isProvided_=function(a){return!goog.implicitNamespaces_[a]&&!!goog.getObjectByName(a)},goog.implicitNamespaces_={});goog.exportPath_=function(a,b,c){a=a.split(".");c=c||goog.global;a[0]in c||!c.execScript||c.execScript("var "+a[0]);for(var d;a.length&&(d=a.shift());)!a.length&&goog.isDef(b)?c[d]=b:c=c[d]?c[d]:c[d]={}};goog.getObjectByName=function(a,b){for(var c=a.split("."),d=b||goog.global,e;e=c.shift();)if(goog.isDefAndNotNull(d[e]))d=d[e];else return null;return d};
goog.globalize=function(a,b){var c=b||goog.global,d;for(d in a)c[d]=a[d]};goog.addDependency=function(a,b,c){if(!COMPILED){var d;a=a.replace(/\\/g,"/");for(var e=goog.dependencies_,f=0;d=b[f];f++)e.nameToPath[d]=a,a in e.pathToNames||(e.pathToNames[a]={}),e.pathToNames[a][d]=!0;for(d=0;b=c[d];d++)a in e.requires||(e.requires[a]={}),e.requires[a][b]=!0}};goog.ENABLE_DEBUG_LOADER=!0;
goog.require=function(a){if(!COMPILED&&!goog.isProvided_(a)){if(goog.ENABLE_DEBUG_LOADER){var b=goog.getPathFromDeps_(a);if(b){goog.included_[b]=!0;goog.writeScripts_();return}}a="goog.require could not find: "+a;goog.global.console&&goog.global.console.error(a);throw Error(a);}};goog.basePath="";goog.nullFunction=function(){};goog.identityFunction=function(a){return a};goog.abstractMethod=function(){throw Error("unimplemented abstract method");};
goog.addSingletonGetter=function(a){a.getInstance=function(){return a.instance_||(a.instance_=new a)}};
!COMPILED&&goog.ENABLE_DEBUG_LOADER&&(goog.included_={},goog.dependencies_={pathToNames:{},nameToPath:{},requires:{},visited:{},written:{}},goog.inHtmlDocument_=function(){var a=goog.global.document;return"undefined"!=typeof a&&"write"in a},goog.findBasePath_=function(){if(goog.global.CLOSURE_BASE_PATH)goog.basePath=goog.global.CLOSURE_BASE_PATH;else if(goog.inHtmlDocument_())for(var a=goog.global.document.getElementsByTagName("script"),b=a.length-1;0<=b;--b){var c=a[b].src,d=c.lastIndexOf("?"),d=
-1==d?c.length:d;if("base.js"==c.substr(d-7,7)){goog.basePath=c.substr(0,d-7);break}}},goog.importScript_=function(a){var b=goog.global.CLOSURE_IMPORT_SCRIPT||goog.writeScriptTag_;!goog.dependencies_.written[a]&&b(a)&&(goog.dependencies_.written[a]=!0)},goog.writeScriptTag_=function(a){return goog.inHtmlDocument_()?(goog.global.document.write('<script type="text/javascript" src="'+a+'">\x3c/script>'),!0):!1},goog.writeScripts_=function(){function a(e){if(!(e in d.written)){if(!(e in d.visited)&&(d.visited[e]=
!0,e in d.requires))for(var h in d.requires[e])if(!goog.isProvided_(h))if(h in d.nameToPath)a(d.nameToPath[h]);else throw Error("Undefined nameToPath for "+h);e in c||(c[e]=!0,b.push(e))}}var b=[],c={},d=goog.dependencies_,e;for(e in goog.included_)d.written[e]||a(e);for(e=0;e<b.length;e++)if(b[e])goog.importScript_(goog.basePath+b[e]);else throw Error("Undefined script input");},goog.getPathFromDeps_=function(a){return a in goog.dependencies_.nameToPath?goog.dependencies_.nameToPath[a]:null},goog.findBasePath_(),
goog.global.CLOSURE_NO_DEPS||goog.importScript_(goog.basePath+"deps.js"));
goog.typeOf=function(a){var b=typeof a;if("object"==b)if(a){if(a instanceof Array)return"array";if(a instanceof Object)return b;var c=Object.prototype.toString.call(a);if("[object Window]"==c)return"object";if("[object Array]"==c||"number"==typeof a.length&&"undefined"!=typeof a.splice&&"undefined"!=typeof a.propertyIsEnumerable&&!a.propertyIsEnumerable("splice"))return"array";if("[object Function]"==c||"undefined"!=typeof a.call&&"undefined"!=typeof a.propertyIsEnumerable&&!a.propertyIsEnumerable("call"))return"function"}else return"null";
else if("function"==b&&"undefined"==typeof a.call)return"object";return b};goog.propertyIsEnumerableCustom_=function(a,b){if(b in a)for(var c in a)if(c==b&&Object.prototype.hasOwnProperty.call(a,b))return!0;return!1};goog.propertyIsEnumerable_=function(a,b){return a instanceof Object?Object.prototype.propertyIsEnumerable.call(a,b):goog.propertyIsEnumerableCustom_(a,b)};goog.isDef=function(a){return void 0!==a};goog.isNull=function(a){return null===a};
goog.isDefAndNotNull=function(a){return null!=a};goog.isArray=function(a){return"array"==goog.typeOf(a)};goog.isArrayLike=function(a){var b=goog.typeOf(a);return"array"==b||"object"==b&&"number"==typeof a.length};goog.isDateLike=function(a){return goog.isObject(a)&&"function"==typeof a.getFullYear};goog.isString=function(a){return"string"==typeof a};goog.isBoolean=function(a){return"boolean"==typeof a};goog.isNumber=function(a){return"number"==typeof a};
goog.isFunction=function(a){return"function"==goog.typeOf(a)};goog.isObject=function(a){a=goog.typeOf(a);return"object"==a||"array"==a||"function"==a};goog.getUid=function(a){return a[goog.UID_PROPERTY_]||(a[goog.UID_PROPERTY_]=++goog.uidCounter_)};goog.removeUid=function(a){"removeAttribute"in a&&a.removeAttribute(goog.UID_PROPERTY_);try{delete a[goog.UID_PROPERTY_]}catch(b){}};goog.UID_PROPERTY_="closure_uid_"+Math.floor(2147483648*Math.random()).toString(36);goog.uidCounter_=0;
goog.getHashCode=goog.getUid;goog.removeHashCode=goog.removeUid;goog.cloneObject=function(a){var b=goog.typeOf(a);if("object"==b||"array"==b){if(a.clone)return a.clone();var b="array"==b?[]:{},c;for(c in a)b[c]=goog.cloneObject(a[c]);return b}return a};goog.bindNative_=function(a,b,c){return a.call.apply(a.bind,arguments)};
goog.bindJs_=function(a,b,c){if(!a)throw Error();if(2<arguments.length){var d=Array.prototype.slice.call(arguments,2);return function(){var c=Array.prototype.slice.call(arguments);Array.prototype.unshift.apply(c,d);return a.apply(b,c)}}return function(){return a.apply(b,arguments)}};goog.bind=function(a,b,c){Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?goog.bind=goog.bindNative_:goog.bind=goog.bindJs_;return goog.bind.apply(null,arguments)};
goog.partial=function(a,b){var c=Array.prototype.slice.call(arguments,1);return function(){var b=Array.prototype.slice.call(arguments);b.unshift.apply(b,c);return a.apply(this,b)}};goog.mixin=function(a,b){for(var c in b)a[c]=b[c]};goog.now=Date.now||function(){return+new Date};
goog.globalEval=function(a){if(goog.global.execScript)goog.global.execScript(a,"JavaScript");else if(goog.global.eval)if(null==goog.evalWorksForGlobals_&&(goog.global.eval("var _et_ = 1;"),"undefined"!=typeof goog.global._et_?(delete goog.global._et_,goog.evalWorksForGlobals_=!0):goog.evalWorksForGlobals_=!1),goog.evalWorksForGlobals_)goog.global.eval(a);else{var b=goog.global.document,c=b.createElement("script");c.type="text/javascript";c.defer=!1;c.appendChild(b.createTextNode(a));b.body.appendChild(c);
b.body.removeChild(c)}else throw Error("goog.globalEval not available");};goog.evalWorksForGlobals_=null;goog.getCssName=function(a,b){var c=function(a){return goog.cssNameMapping_[a]||a},d=function(a){a=a.split("-");for(var b=[],d=0;d<a.length;d++)b.push(c(a[d]));return b.join("-")},d=goog.cssNameMapping_?"BY_WHOLE"==goog.cssNameMappingStyle_?c:d:function(a){return a};return b?a+"-"+d(b):d(a)};goog.setCssNameMapping=function(a,b){goog.cssNameMapping_=a;goog.cssNameMappingStyle_=b};
!COMPILED&&goog.global.CLOSURE_CSS_NAME_MAPPING&&(goog.cssNameMapping_=goog.global.CLOSURE_CSS_NAME_MAPPING);goog.getMsg=function(a,b){var c=b||{},d;for(d in c){var e=(""+c[d]).replace(/\$/g,"$$$$");a=a.replace(RegExp("\\{\\$"+d+"\\}","gi"),e)}return a};goog.exportSymbol=function(a,b,c){goog.exportPath_(a,b,c)};goog.exportProperty=function(a,b,c){a[b]=c};goog.inherits=function(a,b){function c(){}c.prototype=b.prototype;a.superClass_=b.prototype;a.prototype=new c;a.prototype.constructor=a};
goog.base=function(a,b,c){var d=arguments.callee.caller;if(d.superClass_)return d.superClass_.constructor.apply(a,Array.prototype.slice.call(arguments,1));for(var e=Array.prototype.slice.call(arguments,2),f=!1,h=a.constructor;h;h=h.superClass_&&h.superClass_.constructor)if(h.prototype[b]===d)f=!0;else if(f)return h.prototype[b].apply(a,e);if(a[b]===d)return a.constructor.prototype[b].apply(a,e);throw Error("goog.base called from a method of one name to a method of a different name");};
goog.scope=function(a){a.call(goog.global)};var Vizi={Time:function(){if(Vizi.Time.instance)throw Error("Graphics singleton already exists");}};Vizi.Time.prototype.initialize=function(a){this.currentTime=Date.now();Vizi.Time.instance=this};Vizi.Time.prototype.update=function(){this.currentTime=Date.now()};Vizi.Time.instance=null;Vizi.Service=function(){};Vizi.Service.prototype.initialize=function(a){};Vizi.Service.prototype.terminate=function(){};Vizi.Service.prototype.update=function(){};Vizi.EventService=function(){};goog.inherits(Vizi.EventService,Vizi.Service);Vizi.EventService.prototype.initialize=function(a){};Vizi.EventService.prototype.terminate=function(){};Vizi.EventService.prototype.update=function(){do Vizi.EventService.eventsPending=!1,Vizi.Application.instance.updateObjects();while(Vizi.EventService.eventsPending)};Vizi.EventDispatcher=function(){this.eventTypes={};this.timestamps={};this.connections={}};Vizi.EventDispatcher.prototype.addEventListener=function(a,b){var c=this.eventTypes[a];if(c){if(-1!=c.indexOf(b))return}else c=[],this.eventTypes[a]=c,this.timestamps[a]=0;c.push(b)};Vizi.EventDispatcher.prototype.removeEventListener=function(a,b){if(b){var c=this.eventTypes[a];if(c){var d=c.indexOf(b);-1!=d&&c.splice(d,1)}}else delete this.eventTypes[a],delete this.timestamps[a]};
Vizi.EventDispatcher.prototype.dispatchEvent=function(a){var b=this.eventTypes[a];if(b){var c=Vizi.Time.instance.currentTime;if(this.timestamps[a]<c)for(this.timestamps[a]=c,Vizi.EventService.eventsPending=!0,[].shift.call(arguments),c=0;c<b.length;c++)b[c].apply(this,arguments)}};Vizi.EventDispatcher.prototype.hasEventListener=function(a,b){var c=this.eventTypes[type];return c?-1!=c.indexOf(listener):!1};
Vizi.EventDispatcher.prototype.connect=function(a,b,c){var d=this.connections[a];d||(d=[],this.connections[a]=d);var e=this,f=function(){return function(){e.handleConnection(null,b,c,arguments)}}(),h={listener:f,sourceProp:null,target:b,targetProp:c};d.push(h);h=this.addEventListener(a,f)};Vizi.EventDispatcher.prototype.handleConnection=function(a,b,c,d){var e=b[c];"function"==typeof e?e.apply(b,d):"object"==typeof e?e.copy&&"function"==typeof e.copy&&e.copy(a?d[0][a]:d[0]):b[c]=a?d[0][a]:d[0]};Vizi.Object=function(a){Vizi.EventDispatcher.call(this);this._id=Vizi.Object.nextId++;this._parent=null;this._children=[];this._components=[];this.name="";this._realized=!1;var b=!0;a&&void 0!==a.autoCreateTransform&&(b=a.autoCreateTransform);b&&this.addComponent(new Vizi.Transform(a))};goog.inherits(Vizi.Object,Vizi.EventDispatcher);Vizi.Object.nextId=0;Vizi.Object.prototype.getID=function(){return this._id};Vizi.Object.prototype.setParent=function(a){this._parent=a};
Vizi.Object.prototype.addChild=function(a){if(!a)throw Error("Cannot add a null child");if(a._parent)throw Error("Child is already attached to an Object");a.setParent(this);this._children.push(a);this._realized&&!a._realized&&a.realize()};Vizi.Object.prototype.removeChild=function(a){var b=this._children.indexOf(a);-1!=b&&(this._children.splice(b,1),a.removeAllComponents(),a.setParent(null))};Vizi.Object.prototype.getChild=function(a){return a>=this._children.length?null:this._children[a]};
Vizi.Object.prototype.addComponent=function(a){if(!a)throw Error("Cannot add a null component");if(a._object)throw Error("Component is already attached to an Object");var b=Object.getPrototypeOf(a);if(b._componentProperty){if(this[b._componentProperty]){Vizi.System.warn("Object already has a "+b._componentPropertyType+" component");return}this[b._componentProperty]=a}b._componentCategory&&(this[b._componentCategory]||(this[b._componentCategory]=[]),this[b._componentCategory].push(a));this._components.push(a);
a.setObject(this);this._realized&&!a._realized&&a.realize()};Vizi.Object.prototype.removeComponent=function(a){if(a){var b=this._components.indexOf(a);-1!=b&&(a.removeFromScene&&a.removeFromScene(),this._components.splice(b,1),a.setObject(null));b=Object.getPrototypeOf(a);b._componentProperty&&(this[b._componentProperty]=null);if(b._componentCategory&&this[b._componentCategory]){var c=this[b._componentCategory],b=c.indexOf(a);-1!=b&&c.splice(b,1)}}};
Vizi.Object.prototype.removeAllComponents=function(){var a,b=this._components.length;for(a=0;a<b;a++){var c=this._components[a];c.removeFromScene&&c.removeFromScene();c.setObject(null)}};Vizi.Object.prototype.getComponent=function(a){var b,c=this._components.length;for(b=0;b<c;b++){var d=this._components[b];if(d instanceof a)return d}return null};Vizi.Object.prototype.getComponents=function(a){var b,c=this._components.length,d=[];for(b=0;b<c;b++){var e=this._components[b];e instanceof a&&d.push(e)}return d};
Vizi.Object.prototype.realize=function(){this.realizeComponents();this.realizeChildren();this._realized=!0};Vizi.Object.prototype.realizeComponents=function(){for(var a=this._components.length,b=0;b<a;++b)this._components[b].realize()};Vizi.Object.prototype.realizeChildren=function(){for(var a=this._children.length,b=0;b<a;++b)this._children[b].realize()};Vizi.Object.prototype.update=function(){this.updateComponents();this.updateChildren()};
Vizi.Object.prototype.updateComponents=function(){for(var a=this._components.length,b=0;b<a;++b)this._components[b].update()};Vizi.Object.prototype.updateChildren=function(){for(var a=this._children.length,b=0;b<a;++b)this._children[b].update()};Vizi.Object.prototype.traverse=function(a){a(this);var b,c=this._children.length;for(b=0;b<c;b++)this._children[b].traverse(a)};
Vizi.Object.prototype.findCallback=function(a,b,c){if("string"==typeof b)a.name==b&&c.push(a);else if(b instanceof RegExp)(b=a.name.match(b))&&b.length&&c.push(a);else if(b instanceof Function)if(a instanceof b)c.push(a);else{a=a.getComponents(b);var d=a.length;for(b=0;b<d;b++)c.push(a[b])}};Vizi.Object.prototype.findNode=function(a){var b=this,c=[];this.traverse(function(d){b.findCallback(d,a,c)});return c[0]};
Vizi.Object.prototype.findNodes=function(a){var b=this,c=[];this.traverse(function(d){b.findCallback(d,a,c)});return c};Vizi.Object.prototype.map=function(a,b){var c=this.findNodes(a),d,e=c.length;for(d=0;d<e;d++)b(c[d])};Vizi.Component=function(a){Vizi.EventDispatcher.call(this);this._object=null;this._realized=!1};goog.inherits(Vizi.Component,Vizi.EventDispatcher);Vizi.Component.prototype.getObject=function(){return this._object};Vizi.Component.prototype.setObject=function(a){this._object=a};Vizi.Component.prototype.realize=function(){this._realized=!0};Vizi.Component.prototype.update=function(){};Vizi.SceneComponent=function(a){a=a||{};Vizi.Component.call(this,a);Object.defineProperties(this,{position:{get:function(){return this.object.position}},rotation:{get:function(){return this.object.rotation}},scale:{get:function(){return this.object.scale}},quaternion:{get:function(){return this.object.quaternion}},up:{get:function(){return this.object.up},set:function(a){this.object.up=a}},useQuaternion:{get:function(){return this.object.useQuaternion},set:function(a){this.object.useQuaternion=a}},
visible:{get:function(){return this.object.visible},set:function(a){this.object.visible=a}},lookAt:{value:function(a){this.object.lookAt(a)}},translateOnAxis:{value:function(a,c){this.object.translateOnAxis(a,c)}},translateX:{value:function(a){this.object.translateX(a)}},translateY:{value:function(a){this.object.translateY(a)}},translateZ:{value:function(a){this.object.translateZ(a)}}});this.layer=a.layer};goog.inherits(Vizi.SceneComponent,Vizi.Component);
Vizi.SceneComponent.prototype.realize=function(){this.object&&!this.object.data&&this.addToScene();Vizi.Component.prototype.realize.call(this)};Vizi.SceneComponent.prototype.update=function(){Vizi.Component.prototype.update.call(this)};
Vizi.SceneComponent.prototype.addToScene=function(){var a=this.layer?this.layer.scene:Vizi.Graphics.instance.scene;this._object&&this._object.transform.object!=this.object&&(a=this._object.transform?this._object.transform.object:a)&&(a!=this.object.parent&&a.add(this.object),this.object.data=this)};
Vizi.SceneComponent.prototype.removeFromScene=function(){var a=this.layer?this.layer.scene:Vizi.Graphics.instance.scene;this._object&&(a=this._object.transform?this._object.transform.object:a)&&(this.object.data=null,a.remove(this.object));this._realized=!1};Vizi.Camera=function(a){a=a||{};Vizi.SceneComponent.call(this,a);Object.defineProperties(this,{active:{get:function(){return this._active},set:function(a){(this._active=a)&&Vizi.CameraManager.setActiveCamera(this)}}});this._active=a.active||!1};goog.inherits(Vizi.Camera,Vizi.SceneComponent);Vizi.Camera.prototype._componentProperty="camera";Vizi.Camera.prototype._componentPropertyType="Camera";
Vizi.Camera.prototype.realize=function(){Vizi.SceneComponent.prototype.realize.call(this);this.addToScene();Vizi.CameraManager.addCamera(this);this._active&&!Vizi.CameraManager.activeCamera&&Vizi.CameraManager.setActiveCamera(this)};Vizi.Camera.prototype.lookAt=function(a){this.object.lookAt(a)};Vizi.Camera.DEFAULT_POSITION=new THREE.Vector3(0,0,10);Vizi.Camera.DEFAULT_NEAR=1;Vizi.Camera.DEFAULT_FAR=1E4;Vizi.Script=function(a){a=a||{};Vizi.Component.call(this,a)};goog.inherits(Vizi.Script,Vizi.Component);Vizi.Script.prototype._componentCategory="scripts";Vizi.Script.prototype.realize=function(){Vizi.Component.prototype.realize.call(this)};Vizi.Script.prototype.update=function(){Vizi.Script.WARN_ON_ABSTRACT&&Vizi.System.warn("Abstract Script.evaluate called")};Vizi.Script.WARN_ON_ABSTRACT=!0;Vizi.Prefabs={};Vizi.Prefabs.FirstPersonController=function(a){a=a||{};var b=new Vizi.Object(a),c=new Vizi.FirstPersonControllerScript(a);b.addComponent(c);a=new Vizi.DirectionalLight({intensity:a.headlight?1:0});b.addComponent(a);return b};
Vizi.FirstPersonControllerScript=function(a){Vizi.Script.call(this,a);this._enabled=void 0!==a.enabled?a.enabled:!0;this._move=void 0!==a.move?a.move:!0;this._look=void 0!==a.look?a.look:!0;this._turn=void 0!==a.turn?a.turn:!0;this._tilt=void 0!==a.tilt?a.tilt:!0;this._mouseLook=void 0!==a.mouseLook?a.mouseLook:!1;this.collisionDistance=10;this.moveSpeed=13;this.tiltSpeed=this.turnSpeed=5;this.lookSpeed=1;this.savedCameraPos=new THREE.Vector3;this.movementVector=new THREE.Vector3;Object.defineProperties(this,
{camera:{get:function(){return this._camera},set:function(a){this.setCamera(a)}},enabled:{get:function(){return this._enabled},set:function(a){this.setEnabled(a)}},move:{get:function(){return this._move},set:function(a){this.setMove(a)}},look:{get:function(){return this._look},set:function(a){this.setLook(a)}},mouseLook:{get:function(){return this._mouseLook},set:function(a){this.setMouseLook(a)}},headlightOn:{get:function(){return this._headlightOn},set:function(a){this.setHeadlightOn(a)}}})};
goog.inherits(Vizi.FirstPersonControllerScript,Vizi.Script);Vizi.FirstPersonControllerScript.prototype.realize=function(){this.headlight=this._object.getComponent(Vizi.DirectionalLight);this.headlight.intensity=this._headlightOn?1:0};
Vizi.FirstPersonControllerScript.prototype.createControls=function(a){a=new Vizi.FirstPersonControls(a.object,Vizi.Graphics.instance.container);a.mouseLook=this._mouseLook;a.movementSpeed=this._move?this.moveSpeed:0;a.lookSpeed=this._look?this.lookSpeed:0;a.turnSpeed=this._turn?this.turnSpeed:0;a.tiltSpeed=this._tilt?this.tiltSpeed:0;this.clock=new THREE.Clock;return a};
Vizi.FirstPersonControllerScript.prototype.update=function(){this.saveCamera();this.controls.update(this.clock.getDelta());var a=this.testCollision();a&&a.object&&(this.restoreCamera(),this.dispatchEvent("collide",a));this.testTerrain()&&this.restoreCamera();this._headlightOn&&this.headlight.direction.copy(this._camera.position).negate()};Vizi.FirstPersonControllerScript.prototype.setEnabled=function(a){this._enabled=a;this.controls.enabled=a};
Vizi.FirstPersonControllerScript.prototype.setMove=function(a){this._move=a;this.controls.movementSpeed=a?this.moveSpeed:0};Vizi.FirstPersonControllerScript.prototype.setLook=function(a){this._look=a;this.controls.lookSpeed=a?1:0};Vizi.FirstPersonControllerScript.prototype.setMouseLook=function(a){this._mouseLook=a;this.controls.mouseLook=a};
Vizi.FirstPersonControllerScript.prototype.setCamera=function(a){this._camera=a;this.controls=this.createControls(a);this.controls.movementSpeed=this.moveSpeed;this.controls.lookSpeed=this._look?0.1:0};Vizi.FirstPersonControllerScript.prototype.saveCamera=function(){this.savedCameraPos.copy(this._camera.position)};Vizi.FirstPersonControllerScript.prototype.restoreCamera=function(){this._camera.position.copy(this.savedCameraPos)};
Vizi.FirstPersonControllerScript.prototype.testCollision=function(){this.movementVector.copy(this._camera.position).sub(this.savedCameraPos);if(this.movementVector.length()){var a=Vizi.Graphics.instance.objectFromRay(null,this.savedCameraPos,this.movementVector,1,2);a&&a.object&&this.savedCameraPos.distanceTo(a.hitPointWorld);return a}return null};Vizi.FirstPersonControllerScript.prototype.testTerrain=function(){return!1};
Vizi.FirstPersonControllerScript.prototype.setHeadlightOn=function(a){this._headlightOn=a;this.headlight&&(this.headlight.intensity=a?1:0)};Vizi.Transition=function(a){Vizi.Component.call(this,a);a=a||{};this.running=!1;this.duration=a.duration?a.duration:Vizi.Transition.default_duration;this.loop=a.loop?a.loop:!1;this.autoStart=a.autoStart||!1;this.easing=a.easing||Vizi.Transition.default_easing;this.target=a.target;this.to=a.to};goog.inherits(Vizi.Transition,Vizi.Component);Vizi.Transition.prototype.realize=function(){Vizi.Component.prototype.realize.call(this);this.createTweens();this.autoStart&&this.start()};
Vizi.Transition.prototype.createTweens=function(){var a=this.loop?Infinity:0,b=this;this.tween=(new TWEEN.Tween(this.target)).to(this.to,this.duration).easing(this.easing).repeat(a).onComplete(function(){b.onTweenComplete()})};Vizi.Transition.prototype.start=function(){this.running||(this.running=!0,this.tween.start())};Vizi.Transition.prototype.stop=function(){this.running&&(this.running=!1,this.dispatchEvent("complete"),this.tween.stop())};
Vizi.Transition.prototype.onTweenComplete=function(){this.running=!1;this.dispatchEvent("complete")};Vizi.Transition.default_duration=1E3;Vizi.Transition.default_easing=TWEEN.Easing.Linear.None;Vizi.Picker=function(a){a=a||{};Vizi.Component.call(this,a);this.overCursor=a.overCursor;this.enabled=void 0!==a.enabled?a.enabled:!0};goog.inherits(Vizi.Picker,Vizi.Component);Vizi.Picker.prototype._componentCategory="pickers";Vizi.Picker.prototype.realize=function(){Vizi.Component.prototype.realize.call(this);this.lastHitPoint=new THREE.Vector3;this.lastHitNormal=new THREE.Vector3;this.lastHitFace=new THREE.Face3};Vizi.Picker.prototype.update=function(){};
Vizi.Picker.prototype.toModelSpace=function(a){var b=new THREE.Matrix4;b.getInverse(this._object.transform.object.matrixWorld);a.applyMatrix4(b)};Vizi.Picker.prototype.onMouseOver=function(a){this.dispatchEvent("mouseover",a)};Vizi.Picker.prototype.onMouseOut=function(a){this.dispatchEvent("mouseout",a)};
Vizi.Picker.prototype.onMouseMove=function(a){var b=Vizi.PickManager.objectFromMouse(a);if(this._object==Vizi.PickManager.clickedObject||this._object==b)a.point&&this.lastHitPoint.copy(a.point),a.normal&&this.lastHitNormal.copy(a.normal),a.face&&(this.lastHitFace=a.face),a.point&&this.dispatchEvent("mousemove",a)};
Vizi.Picker.prototype.onMouseDown=function(a){this.lastHitPoint.copy(a.point);a.normal&&this.lastHitNormal.copy(a.normal);a.face&&(this.lastHitFace=a.face);this.dispatchEvent("mousedown",a)};Vizi.Picker.prototype.onMouseUp=function(a){Vizi.PickManager.objectFromMouse(a)!=this._object&&(a.point=this.lastHitPoint,a.normal=this.lastHitNormal,a.face=this.lastHitNormal,this.dispatchEvent("mouseout",a));this.dispatchEvent("mouseup",a)};
Vizi.Picker.prototype.onMouseClick=function(a){this.lastHitPoint.copy(a.point);a.normal&&this.lastHitNormal.copy(a.normal);a.face&&(this.lastHitFace=a.face);this.dispatchEvent("click",a)};Vizi.Picker.prototype.onMouseDoubleClick=function(a){this.lastHitPoint.copy(a.point);a.normal&&this.lastHitNormal.copy(a.normal);a.face&&(this.lastHitFace=a.face);this.dispatchEvent("dblclick",a)};Vizi.Picker.prototype.onMouseScroll=function(a){this.dispatchEvent("mousescroll",a)};
Vizi.Picker.prototype.onTouchMove=function(a){this.dispatchEvent("touchmove",a)};Vizi.Picker.prototype.onTouchStart=function(a){this.dispatchEvent("touchstart",a)};Vizi.Picker.prototype.onTouchEnd=function(a){this.dispatchEvent("touchend",a)};Vizi.SurfaceDragger=function(a){a=a||{};Vizi.Picker.call(this,a);this.reference=a.reference;this.dragPlane=new THREE.Plane};goog.inherits(Vizi.SurfaceDragger,Vizi.Picker);Vizi.SurfaceDragger.prototype.realize=function(){Vizi.Picker.prototype.realize.call(this)};Vizi.SurfaceDragger.prototype.update=function(){};
Vizi.SurfaceDragger.prototype.onMouseDown=function(a){Vizi.Picker.prototype.onMouseDown.call(this,a);var b=Vizi.Graphics.instance.getObjectIntersection(a.elementX,a.elementY,this.reference.visuals[0].object);b&&(b=b.point.clone(),this.dragOffset=a.point.clone().sub(this._object.transform.position),this.dispatchEvent("dragstart",{type:"dragstart",offset:b}))};Vizi.SurfaceDragger.prototype.onMouseUp=function(a){Vizi.Picker.prototype.onMouseUp.call(this,a);this.dispatchEvent("dragend",{type:"dragend"})};
Vizi.SurfaceDragger.prototype.onMouseMove=function(a){Vizi.Picker.prototype.onMouseMove.call(this,a);var b=this.reference.visuals[0],c=Vizi.Graphics.instance.getObjectIntersection(a.elementX,a.elementY,b.object);if(c){var d=c.point.clone();a=c.face.normal.clone();var e=b.geometry.vertices,b=e[c.face.a],f=e[c.face.b],c=e[c.face.c];this.dragPlane=(new THREE.Plane).setFromCoplanarPoints(b,f,c);d=d.clone();c=d.clone().add(a);b=(new THREE.Vector3(0,a.z,-a.y)).normalize();b.lengthSq()||b.set(0,a.x,a.y).normalize();
(0>a.x||0>a.z)&&b.negate();this.dispatchEvent("drag",{type:"drag",offset:d,normal:a,up:b,lookAt:c})}};Vizi.Mouse=function(){this.state={x:Vizi.Mouse.NO_POSITION,y:Vizi.Mouse.NO_POSITION,buttons:{left:!1,middle:!1,right:!1},scroll:0};Vizi.Mouse.instance=this};Vizi.Mouse.prototype.onMouseMove=function(a){this.state.x=a.elementX;this.state.y=a.elementY};Vizi.Mouse.prototype.onMouseDown=function(a){this.state.x=a.elementX;this.state.y=a.elementY;this.state.buttons.left=!0};Vizi.Mouse.prototype.onMouseUp=function(a){this.state.x=a.elementX;this.state.y=a.elementY;this.state.buttons.left=!1};
Vizi.Mouse.prototype.onMouseClick=function(a){this.state.x=a.elementX;this.state.y=a.elementY;this.state.buttons.left=!1};Vizi.Mouse.prototype.onMouseDoubleClick=function(a){this.state.x=a.elementX;this.state.y=a.elementY;this.state.buttons.left=!1};Vizi.Mouse.prototype.onMouseScroll=function(a,b){this.state.scroll=0};Vizi.Mouse.prototype.getState=function(){return this.state};Vizi.Mouse.instance=null;Vizi.Mouse.NO_POSITION=Number.MIN_VALUE;Vizi.PointerLockControls=function(a){var b=this;this.speed=0.05;this.speedMultiplier=1;this.fly=!1;this.jumpPower=0.1;this.gravity=0;a.rotation.set(0,0,0);var c=new THREE.Object3D;c.add(a);var d=new THREE.Object3D;d.position.y=10;d.add(c);var e=!1,f=!1,h=!1,m=!1,g=new THREE.Vector3,l=Math.PI/2;document.addEventListener("mousemove",function(a){if(!1!==b.enabled){var e=a.movementY||a.mozMovementY||a.webkitMovementY||0;d.rotation.y-=0.002*(a.movementX||a.mozMovementX||a.webkitMovementX||0);c.rotation.x-=
0.002*e;c.rotation.x=Math.max(-l,Math.min(l,c.rotation.x))}},!1);document.addEventListener("keydown",function(a){switch(a.keyCode){case 16:this.speedMultiplier=10;break;case 17:this.speedMultiplier=0.5;break;case 38:case 87:e=!0;break;case 37:case 65:h=!0;break;case 40:case 83:f=!0;break;case 39:case 68:m=!0;break;case 67:g.y+=this.jumpPower;break;case 32:g.y-=this.jumpPower}}.bind(this),!1);document.addEventListener("keyup",function(a){switch(a.keyCode){case 16:this.speedMultiplier=1;break;case 17:this.speedMultiplier=
1;break;case 38:case 87:e=!1;break;case 37:case 65:h=!1;break;case 40:case 83:f=!1;break;case 39:case 68:m=!1;break;case 32:g.y=0;break;case 67:g.y=0}}.bind(this),!1);this.enabled=!1;this.getObject=function(){return d};this.getPosition=function(){return(new THREE.Vector3).copy(d.position)};this.getDirection=function(){var a=new THREE.Vector3(0,0,-1),b=new THREE.Euler(0,0,0,"YXZ");return function(){v=new THREE.Vector3;b.set(c.rotation.x,d.rotation.y,0);v.copy(a).applyEuler(b);return v}}();this.update=
function(a){!1!==b.enabled&&(a*=0.1,g.x+=0.08*-g.x*a,g.z+=0.08*-g.z*a,g.y-=this.gravity*a,e&&(g.z-=this.speed*a*this.speedMultiplier),f&&(g.z+=this.speed*a*this.speedMultiplier),h&&(g.x-=this.speed*a*this.speedMultiplier),m&&(g.x+=this.speed*a*this.speedMultiplier),d.translateX(g.x),d.translateY(g.y),d.translateZ(g.z),10>d.position.y&&(g.y=0,d.position.y=10))}};Vizi.Timer=function(a){Vizi.Component.call(this);a=a||{};this.currentTime=Vizi.Time.instance.currentTime;this.running=!1;this.duration=a.duration?a.duration:0;this.loop=void 0!==a.loop?a.loop:!1;this.lastFraction=0};goog.inherits(Vizi.Timer,Vizi.Component);
Vizi.Timer.prototype.update=function(){if(this.running){var a=Vizi.Time.instance.currentTime;a-this.currentTime&&this.dispatchEvent("time",a);if(this.duration){var b=a%this.duration/this.duration;this.dispatchEvent("fraction",b);b<this.lastFraction&&(this.dispatchEvent("cycleTime"),this.loop||this.stop());this.lastFraction=b}this.currentTime=a}};Vizi.Timer.prototype.start=function(){this.running=!0;this.currentTime=Vizi.Time.instance.currentTime};
Vizi.Timer.prototype.stop=function(){this.running=!1};Vizi.Transform=function(a){a=a||{};Vizi.SceneComponent.call(this,a);this.object=a.object?a.object:new THREE.Object3D};goog.inherits(Vizi.Transform,Vizi.SceneComponent);Vizi.Transform.prototype._componentProperty="transform";Vizi.Transform.prototype._componentPropertyType="Transform";
Vizi.Transform.prototype.addToScene=function(){var a=this.layer?this.layer.scene:Vizi.Graphics.instance.scene;this._object&&(a=this._object._parent&&this._object._parent.transform?this._object._parent.transform.object:a)&&(a.add(this.object),this.object.data=this)};
Vizi.Transform.prototype.removeFromScene=function(){var a=this.layer?this.layer.scene:Vizi.Graphics.instance.scene;this._object&&(a=this._object._parent&&this._object._parent.transform?this._object._parent.transform.object:a)&&(this.object.data=null,a.remove(this.object))};Vizi.Behavior=function(a){a=a||{};this.startTime=0;this.running=!1;this.loop=void 0!==a.loop?a.loop:!1;this.autoStart=void 0!==a.autoStart?a.autoStart:!1;Vizi.Component.call(this,a)};goog.inherits(Vizi.Behavior,Vizi.Component);Vizi.Behavior.prototype._componentCategory="behaviors";Vizi.Behavior.prototype.realize=function(){Vizi.Component.prototype.realize.call(this);this.autoStart&&this.start()};Vizi.Behavior.prototype.start=function(){this.startTime=Vizi.Time.instance.currentTime;this.running=!0};
Vizi.Behavior.prototype.stop=function(){this.startTime=0;this.running=!1};Vizi.Behavior.prototype.toggle=function(){this.running?this.stop():this.start()};Vizi.Behavior.prototype.update=function(){this.running&&this.evaluate((Vizi.Time.instance.currentTime-this.startTime)/1E3)};Vizi.Behavior.prototype.evaluate=function(a){Vizi.Behavior.WARN_ON_ABSTRACT&&Vizi.System.warn("Abstract Behavior.evaluate called")};Vizi.Behavior.WARN_ON_ABSTRACT=!0;Vizi.FadeBehavior=function(a){a=a||{};this.duration=void 0!==a.duration?a.duration:1;this.opacity=void 0!==a.opacity?a.opacity:0.5;this.savedOpacities=[];this.savedTransparencies=[];this.tween=null;Vizi.Behavior.call(this,a)};goog.inherits(Vizi.FadeBehavior,Vizi.Behavior);
Vizi.FadeBehavior.prototype.start=function(){if(!this.running){if(this._realized&&this._object.visuals){var a=this._object.visuals,b,c=a.length;for(b=0;b<c;b++)this.savedOpacities.push(a[b].material.opacity),this.savedTransparencies.push(a[b].material.transparent),a[b].material.transparent=1>this.opacity?!0:!1}this.value={opacity:this.savedOpacities[0]};this.targetValue={opacity:this.opacity};this.tween=(new TWEEN.Tween(this.value)).to(this.targetValue,1E3*this.duration).easing(TWEEN.Easing.Quadratic.InOut).repeat(0).start();
Vizi.Behavior.prototype.start.call(this)}};Vizi.FadeBehavior.prototype.evaluate=function(a){a>=this.duration&&(this.stop(),this.loop&&this.start());if(this._object.visuals){a=this._object.visuals;var b,c=a.length;for(b=0;b<c;b++)a[b].material.opacity=this.value.opacity}};Vizi.FadeBehavior.prototype.stop=function(){this.tween&&this.tween.stop();Vizi.Behavior.prototype.stop.call(this)};Vizi.Light=function(a){a=a||{};Vizi.SceneComponent.call(this,a);Object.defineProperties(this,{color:{get:function(){return this.object.color}},intensity:{get:function(){return this.object.intensity},set:function(a){this.object.intensity=a}}})};goog.inherits(Vizi.Light,Vizi.SceneComponent);Vizi.Light.prototype._componentProperty="light";Vizi.Light.prototype._componentPropertyType="Light";Vizi.Light.prototype.realize=function(){Vizi.SceneComponent.prototype.realize.call(this)};
Vizi.Light.DEFAULT_COLOR=16777215;Vizi.Light.DEFAULT_INTENSITY=1;Vizi.Light.DEFAULT_RANGE=1E4;Vizi.DirectionalLight=function(a){a=a||{};this.scaledDir=new THREE.Vector3;this.castShadows=void 0!==a.castShadows?a.castShadows:Vizi.DirectionalLight.DEFAULT_CAST_SHADOWS;Vizi.Light.call(this,a);a.object?(this.object=a.object,this.direction=a.object.position.clone().normalize().negate(),this.targetPos=a.object.target.position.clone(),this.shadowDarkness=a.object.shadowDarkness):(this.direction=a.direction||new THREE.Vector3(0,0,-1),this.object=new THREE.DirectionalLight(a.color,a.intensity,0),this.targetPos=
new THREE.Vector3,this.shadowDarkness=void 0!==a.shadowDarkness?a.shadowDarkness:Vizi.DirectionalLight.DEFAULT_SHADOW_DARKNESS)};goog.inherits(Vizi.DirectionalLight,Vizi.Light);Vizi.DirectionalLight.prototype.realize=function(){Vizi.Light.prototype.realize.call(this)};
Vizi.DirectionalLight.prototype.update=function(){this.position.copy(this.direction).normalize().negate();this.position.applyMatrix4(this.object.parent.matrixWorld);this.scaledDir.copy(this.direction);this.scaledDir.multiplyScalar(Vizi.Light.DEFAULT_RANGE);this.targetPos.copy(this.position);this.targetPos.add(this.scaledDir);this.object.target.position.copy(this.targetPos);this.updateShadows();Vizi.Light.prototype.update.call(this)};
Vizi.DirectionalLight.prototype.updateShadows=function(){this.castShadows&&(this.object.castShadow=!0,this.object.shadowCameraNear=1,this.object.shadowCameraFar=Vizi.Light.DEFAULT_RANGE,this.object.shadowCameraFov=90,this.object.shadowBias=1E-4,this.object.shadowDarkness=this.shadowDarkness,this.object.shadowMapWidth=1024,this.object.shadowMapHeight=1024,Vizi.Graphics.instance.enableShadows(!0))};Vizi.DirectionalLight.DEFAULT_CAST_SHADOWS=!1;Vizi.DirectionalLight.DEFAULT_SHADOW_DARKNESS=0.3;Vizi.PointLight=function(a){a=a||{};Vizi.Light.call(this,a);this.positionVec=new THREE.Vector3;this.object=a.object?a.object:new THREE.PointLight(a.color,a.intensity,void 0!==a.distance?a.distance:Vizi.PointLight.DEFAULT_DISTANCE);Object.defineProperties(this,{distance:{get:function(){return this.object.distance},set:function(a){this.object.distance=a}}})};goog.inherits(Vizi.PointLight,Vizi.Light);Vizi.PointLight.prototype.realize=function(){Vizi.Light.prototype.realize.call(this)};
Vizi.PointLight.prototype.update=function(){this.object&&(this.positionVec.set(0,0,0),this.positionVec.applyMatrix4(this.object.parent.matrixWorld),this.position.copy(this.positionVec));Vizi.Light.prototype.update.call(this)};Vizi.PointLight.DEFAULT_DISTANCE=0;Vizi.Prefabs.DeviceOrientationController=function(a){a=a||{};var b=new Vizi.Object(a);a=new Vizi.DeviceOrientationControllerScript(a);b.addComponent(a);return b};Vizi.DeviceOrientationControllerScript=function(a){Vizi.Script.call(this,a);this._enabled=void 0!==a.enabled?a.enabled:!0;this.roll=void 0!==a.roll?a.roll:!0;Object.defineProperties(this,{camera:{get:function(){return this._camera},set:function(a){this.setCamera(a)}},enabled:{get:function(){return this._enabled},set:function(a){this.setEnabled(a)}}})};
goog.inherits(Vizi.DeviceOrientationControllerScript,Vizi.Script);Vizi.DeviceOrientationControllerScript.prototype.realize=function(){};Vizi.DeviceOrientationControllerScript.prototype.createControls=function(a){a=new Vizi.DeviceOrientationControls(a.object);this._enabled&&a.connect();a.roll=this.roll;return a};Vizi.DeviceOrientationControllerScript.prototype.update=function(){this._enabled&&this.controls.update()};
Vizi.DeviceOrientationControllerScript.prototype.setEnabled=function(a){(this._enabled=a)?this.controls.connect():this.controls.disconnect()};Vizi.DeviceOrientationControllerScript.prototype.setCamera=function(a){this._camera=a;this.controls=this.createControls(a)};Vizi.Visual=function(a){a=a||{};Vizi.SceneComponent.call(this,a);a.object?(this.object=a.object,this.geometry=this.object.geometry,this.material=this.object.material):(this.geometry=a.geometry,this.material=a.material)};goog.inherits(Vizi.Visual,Vizi.SceneComponent);Vizi.Visual.prototype._componentCategory="visuals";
Vizi.Visual.prototype.realize=function(){Vizi.SceneComponent.prototype.realize.call(this);!this.object&&(this.geometry&&this.material)&&(this.object=new THREE.Mesh(this.geometry,this.material),this.object.ignorePick=!1,this.addToScene())};Vizi.SceneVisual=function(a){a=a||{};Vizi.Visual.call(this,a);this.object=a.scene};goog.inherits(Vizi.SceneVisual,Vizi.Visual);Vizi.SceneVisual.prototype.realize=function(){Vizi.Visual.prototype.realize.call(this);this.addToScene()};Vizi.Keyboard=function(){Vizi.Keyboard.instance=this};Vizi.Keyboard.prototype.onKeyDown=function(a){};Vizi.Keyboard.prototype.onKeyUp=function(a){};Vizi.Keyboard.prototype.onKeyPress=function(a){};Vizi.Keyboard.instance=null;Vizi.Keyboard.KEY_LEFT=37;Vizi.Keyboard.KEY_UP=38;Vizi.Keyboard.KEY_RIGHT=39;Vizi.Keyboard.KEY_DOWN=40;Vizi.Graphics=function(){if(Vizi.Graphics.instance)throw Error("Graphics singleton already exists");Vizi.Graphics.instance=this};Vizi.Graphics.instance=null;Vizi.MoveBehavior=function(a){a=a||{};this.duration=void 0!==a.duration?a.duration:1;this.moveVector=void 0!==a.moveVector?a.moveVector:new THREE.Vector3(0,1,0);this.tween=null;Vizi.Behavior.call(this,a)};goog.inherits(Vizi.MoveBehavior,Vizi.Behavior);
Vizi.MoveBehavior.prototype.start=function(){this.running||(this.movePosition=new THREE.Vector3,this.moveEndPosition=this.moveVector.clone(),this.prevMovePosition=new THREE.Vector3,this.moveDelta=new THREE.Vector3,this.tween=(new TWEEN.Tween(this.movePosition)).to(this.moveEndPosition,1E3*this.duration).easing(TWEEN.Easing.Quadratic.InOut).repeat(0).start(),Vizi.Behavior.prototype.start.call(this))};
Vizi.MoveBehavior.prototype.evaluate=function(a){a>=this.duration&&(this.stop(),this.loop?this.start():this.dispatchEvent("complete"));this.moveDelta.copy(this.movePosition).sub(this.prevMovePosition);this.prevMovePosition.copy(this.movePosition);this._object.transform.position.add(this.moveDelta)};Vizi.MoveBehavior.prototype.stop=function(){this.tween&&this.tween.stop();Vizi.Behavior.prototype.stop.call(this)};Vizi.PickManager={};
Vizi.PickManager.handleMouseMove=function(a){if(Vizi.PickManager.clickedObject){var b=Vizi.PickManager.clickedObject.pickers,c,d=b.length;for(c=0;c<d;c++)if(b[c].enabled&&b[c].onMouseMove)b[c].onMouseMove(a)}else{b=Vizi.PickManager.overObject;Vizi.PickManager.overObject=Vizi.PickManager.objectFromMouse(a);if(Vizi.PickManager.overObject!=b){if(b)for(Vizi.Graphics.instance.setCursor(null),a.type="mouseout",b=b.pickers,d=b.length,c=0;c<d;c++)if(b[c].enabled&&b[c].onMouseOut)b[c].onMouseOut(a);if(Vizi.PickManager.overObject)for(a.type=
"mouseover",b=Vizi.PickManager.overObject.pickers,d=b.length,c=0;c<d;c++)if(b[c].enabled&&b[c].overCursor&&Vizi.Graphics.instance.setCursor(b[c].overCursor),b[c].enabled&&b[c].onMouseOver)b[c].onMouseOver(a)}if(Vizi.PickManager.overObject)for(b=Vizi.PickManager.overObject.pickers,d=b.length,c=0;c<d;c++)b[c].enabled&&(b[c].moveWithoutCapture&&b[c].onMouseMove)&&(a.type="mousemove",b[c].onMouseMove(a))}};
Vizi.PickManager.handleMouseDown=function(a){Vizi.PickManager.clickedObject=Vizi.PickManager.objectFromMouse(a);if(Vizi.PickManager.clickedObject){var b=Vizi.PickManager.clickedObject.pickers,c,d=b.length;for(c=0;c<d;c++)if(b[c].enabled&&b[c].onMouseDown)b[c].onMouseDown(a)}};
Vizi.PickManager.handleMouseUp=function(a){if(Vizi.PickManager.clickedObject){var b=Vizi.PickManager.objectFromMouse(a),c=Vizi.PickManager.clickedObject.pickers,d,e=c.length;for(d=0;d<e;d++)c[d].enabled&&c[d].onMouseUp&&(c[d].onMouseUp(a),b==Vizi.PickManager.clickedObject&&(a.type="click",c[d].onMouseClick(a)))}Vizi.PickManager.clickedObject=null};Vizi.PickManager.handleMouseClick=function(a){};
Vizi.PickManager.handleMouseDoubleClick=function(a){Vizi.PickManager.clickedObject=Vizi.PickManager.objectFromMouse(a);if(Vizi.PickManager.clickedObject){var b=Vizi.PickManager.clickedObject.pickers,c,d=b.length;for(c=0;c<d;c++)if(b[c].enabled&&b[c].onMouseDoubleClick)b[c].onMouseDoubleClick(a)}Vizi.PickManager.clickedObject=null};
Vizi.PickManager.handleMouseScroll=function(a){if(Vizi.PickManager.overObject){var b=Vizi.PickManager.overObject.pickers,c,d=b.length;for(c=0;c<d;c++)if(b[c].enabled&&b[c].onMouseScroll)b[c].onMouseScroll(a)}Vizi.PickManager.clickedObject=null};
Vizi.PickManager.handleTouchStart=function(a){if(0<a.touches.length&&(a.screenX=a.touches[0].screenX,a.screenY=a.touches[0].screenY,a.clientX=a.touches[0].clientX,a.clientY=a.touches[0].clientY,a.pageX=a.touches[0].pageX,a.pageY=a.touches[0].pageY,a.elementX=a.touches[0].elementX,a.elementY=a.touches[0].elementY,Vizi.PickManager.clickedObject=Vizi.PickManager.objectFromMouse(a),Vizi.PickManager.clickedObject)){var b=Vizi.PickManager.clickedObject.pickers,c,d=b.length;for(c=0;c<d;c++)if(b[c].enabled&&
b[c].onTouchStart)b[c].onTouchStart(a)}};Vizi.PickManager.handleTouchMove=function(a){if(0<a.touches.length&&(a.screenX=a.touches[0].screenX,a.screenY=a.touches[0].screenY,a.clientX=a.touches[0].clientX,a.clientY=a.touches[0].clientY,a.pageX=a.touches[0].pageX,a.pageY=a.touches[0].pageY,a.elementX=a.touches[0].elementX,a.elementY=a.touches[0].elementY,Vizi.PickManager.clickedObject)){var b=Vizi.PickManager.clickedObject.pickers,c,d=b.length;for(c=0;c<d;c++)if(b[c].enabled&&b[c].onTouchMove)b[c].onTouchMove(a)}};
Vizi.PickManager.handleTouchEnd=function(a){if(0<a.changedTouches.length){a.screenX=a.changedTouches[0].screenX;a.screenY=a.changedTouches[0].screenY;a.clientX=a.changedTouches[0].clientX;a.clientY=a.changedTouches[0].clientY;a.pageX=a.changedTouches[0].pageX;a.pageY=a.changedTouches[0].pageY;a.elementX=a.changedTouches[0].elementX;a.elementY=a.changedTouches[0].elementY;if(Vizi.PickManager.clickedObject){var b=Vizi.PickManager.clickedObject.pickers,c,d=b.length;for(c=0;c<d;c++)if(b[c].enabled&&b[c].onTouchEnd)b[c].onTouchEnd(a)}Vizi.PickManager.clickedObject=
null}};Vizi.PickManager.objectFromMouse=function(a){var b=Vizi.Graphics.instance.objectFromMouse(a);if(b.object){a.face=b.face;a.normal=b.normal;a.point=b.point;a.object=b.object;if(b.object._object.pickers){var c=b.object._object.pickers,d,e=c.length;for(d=0;d<e;d++)if(c[d].enabled)return b.object._object}return Vizi.PickManager.findObjectPicker(a,b.hitPointWorld,b.object.object)}return null};
Vizi.PickManager.findObjectPicker=function(a,b,c){for(;c;){if(c.data&&c.data._object.pickers){var d=c.data._object.pickers,e,f=d.length;for(e=0;e<f;e++)if(d[e].enabled)return d=new THREE.Matrix4,d.getInverse(c.matrixWorld),a.point=b.clone(),a.point.applyMatrix4(d),c.data._object}c=c.parent}return null};Vizi.PickManager.clickedObject=null;Vizi.PickManager.overObject=null;Vizi.AmbientLight=function(a){a=a||{};Vizi.Light.call(this,a);this.object=a.object?a.object:new THREE.AmbientLight(a.color)};goog.inherits(Vizi.AmbientLight,Vizi.Light);Vizi.AmbientLight.prototype.realize=function(){Vizi.Light.prototype.realize.call(this)};Vizi.Input=function(){this.mouse=new Vizi.Mouse;this.keyboard=new Vizi.Keyboard;this.gamepad=new Vizi.Gamepad;Vizi.Input.instance=this};goog.inherits(Vizi.Input,Vizi.Service);Vizi.Input.prototype.update=function(){this.gamepad&&this.gamepad.update&&this.gamepad.update()};Vizi.Input.instance=null;Vizi.CylinderDragger=function(a){a=a||{};Vizi.Picker.call(this,a);this.normal=a.normal||new THREE.Vector3(0,1,0);this.position=a.position||new THREE.Vector3;this.color=11141120};goog.inherits(Vizi.CylinderDragger,Vizi.Picker);
Vizi.CylinderDragger.prototype.realize=function(){Vizi.Picker.prototype.realize.call(this);this.dragObject=null;this.dragOffset=new THREE.Euler;this.currentOffset=new THREE.Euler;this.dragHitPoint=new THREE.Vector3;this.dragStartPoint=new THREE.Vector3;this.dragPlane=this.createDragPlane();this.dragPlane.visible=Vizi.CylinderDragger.SHOW_DRAG_PLANE;this.dragPlane.ignorePick=!0;this.dragPlane.ignoreBounds=!0;this._object.transform.object.add(this.dragPlane)};
Vizi.CylinderDragger.prototype.createDragPlane=function(){var a=this.normal,b=this.position,c=(new THREE.Vector3(0,a.z,-a.y)).normalize().multiplyScalar(2E3);c.lengthSq()||(c=(new THREE.Vector3(-a.z,a.x,0)).normalize().multiplyScalar(2E3));var d=c.clone().cross(a).normalize().multiplyScalar(2E3),e=b.clone().sub(c).sub(d),f=b.clone().add(c).sub(d),h=b.clone().add(c).add(d),c=b.clone().sub(c).add(d),b=new THREE.Geometry;b.vertices.push(e,f,h,c);e=new THREE.Face3(0,2,1);e.normal.copy(a);e.vertexNormals.push(a.clone(),
a.clone(),a.clone(),a.clone());b.faces.push(e);e=new THREE.Face3(0,3,2);e.normal.copy(a);e.vertexNormals.push(a.clone(),a.clone(),a.clone(),a.clone());b.faces.push(e);b.computeFaceNormals();a=new THREE.MeshBasicMaterial({color:this.color,transparent:!0,side:THREE.DoubleSide,opacity:0.1});return new THREE.Mesh(b,a)};Vizi.CylinderDragger.prototype.update=function(){};Vizi.CylinderDragger.prototype.onMouseDown=function(a){Vizi.Picker.prototype.onMouseDown.call(this,a);this.handleMouseDown(a)};
Vizi.CylinderDragger.prototype.handleMouseDown=function(a){if(this.dragPlane){var b=Vizi.Graphics.instance.getObjectIntersection(a.elementX,a.elementY,this.dragPlane);b&&(this.dragStartPoint.copy(b.point).normalize(),this.dragObject=a.object,this.dispatchEvent("dragstart",{type:"dragstart",offset:b.point}))}Vizi.CylinderDragger.SHOW_DRAG_NORMAL&&(this.arrowDecoration&&this._object.removeComponent(this.arrowDecoration),a=new THREE.ArrowHelper(this.normal,new THREE.Vector3,500,65280,5,5),a=new Vizi.Decoration({object:a}),
this._object.addComponent(a),this.arrowDecoration=a)};Vizi.CylinderDragger.prototype.onMouseMove=function(a){Vizi.Picker.prototype.onMouseMove.call(this,a);this.handleMouseMove(a)};
Vizi.CylinderDragger.prototype.handleMouseMove=function(a){if(a=Vizi.Graphics.instance.getObjectIntersection(a.elementX,a.elementY,this.dragPlane)){var b=a.point.clone().normalize();a=Math.acos(b.dot(this.dragStartPoint));b=b.clone().cross(this.dragStartPoint);0<this.normal.dot(b)&&(a=-a);this.currentOffset.set(this.dragOffset.x+this.normal.x*a,this.dragOffset.y+this.normal.y*a,this.dragOffset.z+this.normal.z*a);this.dispatchEvent("drag",{type:"drag",offset:this.currentOffset})}};
Vizi.CylinderDragger.prototype.onMouseUp=function(a){Vizi.Picker.prototype.onMouseUp.call(this,a);this.handleMouseUp(a)};Vizi.CylinderDragger.prototype.handleMouseUp=function(a){this.arrowDecoration&&this._object.removeComponent(this.arrowDecoration)};Vizi.CylinderDragger.prototype.onTouchStart=function(a){Vizi.Picker.prototype.onTouchStart.call(this,a);this.handleMouseDown(a)};Vizi.CylinderDragger.prototype.onTouchMove=function(a){Vizi.Picker.prototype.onTouchMove.call(this,a);this.handleMouseMove(a)};
Vizi.CylinderDragger.prototype.onTouchEnd=function(a){Vizi.Picker.prototype.onTouchEnd.call(this,a);this.handleMouseUp(a)};Vizi.CylinderDragger.SHOW_DRAG_PLANE=!1;Vizi.CylinderDragger.SHOW_DRAG_NORMAL=!1;Vizi.RotateBehavior=function(a){a=a||{};this.duration=void 0!==a.duration?a.duration:1;this.velocity=void 0!==a.velocity?a.velocity:Math.PI/2/this.duration;this.angle=this.startAngle=0;Vizi.Behavior.call(this,a)};goog.inherits(Vizi.RotateBehavior,Vizi.Behavior);Vizi.RotateBehavior.prototype.start=function(){this.angle=0;this._object.transform.rotation.y%=2*Math.PI;this.startAngle=this._object.transform.rotation.y;Vizi.Behavior.prototype.start.call(this)};
Vizi.RotateBehavior.prototype.evaluate=function(a){var b=2*Math.PI;this.angle=this.velocity*a;this.angle>=b&&(this.angle=this.once?b:this.angle%b);this._object.transform.rotation.y=this.startAngle+this.angle;this.once&&this.angle>=b&&this.stop()};Vizi.FirstPersonControls=function(a,b){function c(a,b){return function(){b.apply(a,arguments)}}this.object=a;this.target=new THREE.Vector3(0,0,0);this.domElement=void 0!==b?b:document;this.lookSpeed=this.movementSpeed=1;this.tiltSpeed=this.turnSpeed=5;this.touchScreenY=this.touchScreenX=this.lastMouseY=this.lastMouseX=this.mouseY=this.mouseX=this.tiltAngle=this.turnAngle=0;this.moveTouchId=this.lookTouchId=-1;this.theta=this.phi=this.lon=this.lat=0;this.mouseLook=this.mouseDragOn=this.tiltDown=this.tiltUp=
this.turnLeft=this.turnRight=this.moveRight=this.moveLeft=this.moveBackward=this.moveForward=!1;this.viewHalfY=this.viewHalfX=0;this.domElement!==document&&this.domElement.setAttribute("tabindex",-1);this.handleResize=function(){this.domElement===document?(this.viewHalfX=window.innerWidth/2,this.viewHalfY=window.innerHeight/2):(this.viewHalfX=this.domElement.offsetWidth/2,this.viewHalfY=this.domElement.offsetHeight/2)};this.onMouseDown=function(a){this.domElement===document?(this.mouseX=a.pageX-this.viewHalfX,
this.mouseY=a.pageY-this.viewHalfY):(this.mouseX=a.pageX-this.domElement.offsetLeft-this.viewHalfX,this.mouseY=a.pageY-this.domElement.offsetTop-this.viewHalfY);this.lastMouseX=this.mouseX;this.lastMouseY=this.mouseY;this.mouseDragOn=!0};this.onMouseUp=function(a){this.mouseDragOn=!1};this.onMouseMove=function(a){this.domElement===document?(this.mouseX=a.pageX-this.viewHalfX,this.mouseY=a.pageY-this.viewHalfY):(this.mouseX=a.pageX-this.domElement.offsetLeft-this.viewHalfX,this.mouseY=a.pageY-this.domElement.offsetTop-
this.viewHalfY)};this.onTouchStart=function(a){a.preventDefault();0<a.touches.length&&(-1==this.lookTouchId?(this.lookTouchId=a.touches[0].identifier,this.onMouseDown({type:"mousedown",view:a.view,bubbles:a.bubbles,cancelable:a.cancelable,detail:a.detail,screenX:a.touches[0].screenX,screenY:a.touches[0].screenY,clientX:a.touches[0].clientX,clientY:a.touches[0].clientY,pageX:a.touches[0].pageX,pageY:a.touches[0].pageY,button:0,preventDefault:a.preventDefault})):(this.touchScreenX=a.touches[1].screenX,
this.touchScreenY=a.touches[1].screenY,this.moveTouchId=a.touches[1].identifier))};this.onTouchMove=function(a){a.preventDefault();for(var b=null,c=null,d=a.changedTouches.length,g=0;g<d;g++)a.changedTouches[g].identifier==this.lookTouchId&&(b=a.changedTouches[g]),a.changedTouches[g].identifier==this.moveTouchId&&(c=a.changedTouches[g]);if(b)this.onMouseMove({type:"mousemove",view:a.view,bubbles:a.bubbles,cancelable:a.cancelable,detail:a.detail,screenX:b.screenX,screenY:b.screenY,clientX:b.clientX,
clientY:b.clientY,pageX:b.pageX,pageY:b.pageY,button:0,preventDefault:a.preventDefault});c&&(a=c.screenX-this.touchScreenX,b=c.screenY-this.touchScreenY,this.touchScreenX=c.screenX,this.touchScreenY=c.screenY,0<a&&(this.moveRight=!0),0>a&&(this.moveLeft=!0),0<b&&(this.moveBackward=!0),0>b&&(this.moveForward=!0))};this.onTouchEnd=function(a){a.preventDefault();for(var b=null,c=null,d=a.changedTouches.length,g=0;g<d;g++)a.changedTouches[g].identifier==this.lookTouchId&&(b=a.changedTouches[g]),a.changedTouches[g].identifier==
this.moveTouchId&&(c=a.changedTouches[g]);b&&(this.onMouseUp({type:"mouseup",view:a.view,bubbles:a.bubbles,cancelable:a.cancelable,detail:a.detail,screenX:b.screenX,screenY:b.screenY,clientX:b.clientX,clientY:b.clientY,pageX:b.pageX,pageY:b.pageY,button:0,preventDefault:a.preventDefault}),this.lookTouchId=-1);c&&(this.touchScreenX=c.screenX,this.touchScreenY=c.screenY,this.moveForward=this.moveBackward=this.moveLeft=this.moveRight=!1,this.moveTouchId=-1)};this.onGamepadButtonsChanged=function(a){};
this.onGamepadAxesChanged=function(a){a=a.changedAxes;var b,c=a.length;for(b=0;b<c;b++){var d=a[b];d.axis==Vizi.Gamepad.AXIS_LEFT_V?-0.2>d.value?(this.moveForward=!0,this.moveBackward=!1):(this.moveBackward=0.2<d.value?!0:!1,this.moveForward=!1):d.axis==Vizi.Gamepad.AXIS_LEFT_H?0.5<d.value?(this.moveRight=!0,this.moveLeft=!1):(this.moveLeft=-0.5>d.value?!0:!1,this.moveRight=!1):d.axis==Vizi.Gamepad.AXIS_RIGHT_V?-0.2>d.value?(this.tiltUp=!0,this.tiltDown=!1):(this.tiltDown=0.2<d.value?!0:!1,this.tiltUp=
!1):d.axis==Vizi.Gamepad.AXIS_RIGHT_H&&(0.5<d.value?(this.turnLeft=!0,this.turnRight=!1):-0.5>d.value?(this.turnRight=!0,this.turnLeft=!1):this.turnRight=this.turnLeft=!1)}};this.onKeyDown=function(a){switch(a.keyCode){case 38:case 87:this.moveForward=!0;break;case 37:case 65:this.moveLeft=!0;break;case 40:case 83:this.moveBackward=!0;break;case 39:case 68:this.moveRight=!0;break;case 82:this.moveUp=!0;break;case 70:this.moveDown=!0}};this.onKeyUp=function(a){switch(a.keyCode){case 38:case 87:this.moveForward=
!1;break;case 37:case 65:this.moveLeft=!1;break;case 40:case 83:this.moveBackward=!1;break;case 39:case 68:this.moveRight=!1;break;case 82:this.moveUp=!1;break;case 70:this.moveDown=!1}};this.update=function(a){if(!1!==this.enabled){this.startY=this.object.position.y;a*=this.movementSpeed;this.moveForward&&this.object.translateZ(-a);this.moveBackward&&this.object.translateZ(a);this.moveLeft&&this.object.translateX(-a);this.moveRight&&this.object.translateX(a);this.object.position.y=this.startY;if((this.mouseDragOn||
this.mouseLook)&&this.lookSpeed){a=this.lastMouseX-this.mouseX;Math.abs(a);a=900*(a/this.viewHalfX);this.lon+=a*this.lookSpeed;a=this.lastMouseY-this.mouseY;Math.abs(a);a=900*(a/this.viewHalfY);this.lat+=a*this.lookSpeed;this.theta=THREE.Math.degToRad(this.lon);this.lat=Math.max(-85,Math.min(85,this.lat));this.phi=THREE.Math.degToRad(this.lat);a=this.target;var b=this.object.position;a.x=b.x-Math.sin(this.theta);a.y=b.y+Math.sin(this.phi);a.z=b.z-Math.cos(this.theta);this.object.lookAt(a);this.lastMouseX=
this.mouseX;this.lastMouseY=this.mouseY}if(this.turnRight||this.turnLeft||this.tiltUp||this.tiltDown)a=0,this.turnRight?a=1:this.turnLeft&&(a=-1),this.lon+=a*this.turnSpeed,a=0,this.tiltUp?a=1:this.tiltDown&&(a=-1),this.lat+=a*this.tiltSpeed,this.theta=THREE.Math.degToRad(this.lon),this.lat=Math.max(-85,Math.min(85,this.lat)),this.phi=THREE.Math.degToRad(this.lat),a=this.target,b=this.object.position,this.turnSpeed&&(a.x=b.x-Math.sin(this.theta)),this.tiltSpeed&&(a.y=b.y+Math.sin(this.phi),a.z=b.z-
Math.cos(this.theta)),(this.turnSpeed||this.tiltSpeed)&&this.object.lookAt(a)}};this.domElement.addEventListener("contextmenu",function(a){a.preventDefault()},!1);this.domElement.addEventListener("mousemove",c(this,this.onMouseMove),!0);this.domElement.addEventListener("mousedown",c(this,this.onMouseDown),!1);this.domElement.addEventListener("mouseup",c(this,this.onMouseUp),!1);this.domElement.addEventListener("touchstart",c(this,this.onTouchStart),!1);this.domElement.addEventListener("touchmove",
c(this,this.onTouchMove),!1);this.domElement.addEventListener("touchend",c(this,this.onTouchEnd),!1);this.domElement.addEventListener("keydown",c(this,this.onKeyDown),!1);this.domElement.addEventListener("keyup",c(this,this.onKeyUp),!1);this.domElement.addEventListener("resize",c(this,this.handleResize),!1);var d=Vizi.Gamepad.instance;d&&(d.addEventListener("buttonsChanged",c(this,this.onGamepadButtonsChanged),!1),d.addEventListener("axesChanged",c(this,this.onGamepadAxesChanged),!1));this.handleResize()};Vizi.OrbitControls=function(a,b){function c(){return 2*Math.PI/60/60*k.autoRotateSpeed}function d(a){!1!==k.enabled&&!1!==k.userRotate&&(a.preventDefault(),0===a.button||k.oneButton&&2===a.button?(p=n.ROTATE,q.set(a.clientX,a.clientY)):1===a.button&&k.userZoom?(p=n.ZOOM,w.set(a.clientX,a.clientY)):2===a.button&&k.userPan&&(p=n.PAN),k.domElement.addEventListener("mousemove",e,!1),k.domElement.addEventListener("mouseup",m,!1),k.domElement.addEventListener("touchmove",f,!1),k.domElement.addEventListener("touchend",
g,!1))}function e(a){!1!==k.enabled&&(a.preventDefault(),p===n.ROTATE?(x.set(a.clientX,a.clientY),y.subVectors(x,q),k.rotateLeft(2*Math.PI*y.x/r*k.userRotateSpeed),k.rotateUp(2*Math.PI*y.y/r*k.userRotateSpeed),q.copy(x)):p===n.ZOOM?(z.set(a.clientX,a.clientY),A.subVectors(z,w),0<A.y?k.zoomIn():k.zoomOut(),w.copy(z)):p===n.PAN&&k.pan(new THREE.Vector3(-(a.movementX||a.mozMovementX||a.webkitMovementX||0),a.movementY||a.mozMovementY||a.webkitMovementY||0,0)))}function f(a){if(!1!==k.enabled)if(1<a.changedTouches.length){for(var b=
null,c=null,d=0;d<a.changedTouches.length;d++)a.changedTouches[d].identifier==k.touchId0?b=a.changedTouches[d]:a.changedTouches[d].identifier==k.touchId1&&(c=a.changedTouches[d]);b&&(c&&k.userZoom)&&(a=h(b,c),b=a-k.touchDistance,0<b?k.zoomIn():0>b&&k.zoomOut(),k.touchDistance=a)}else k.userRotate&&e({type:"mousemove",view:a.view,bubbles:a.bubbles,cancelable:a.cancelable,detail:a.detail,screenX:a.changedTouches[0].screenX,screenY:a.changedTouches[0].screenY,clientX:a.changedTouches[0].clientX,clientY:a.changedTouches[0].clientY,
pageX:a.changedTouches[0].pageX,pageY:a.changedTouches[0].pageY,button:0,preventDefault:function(){}})}function h(a,b){var c=b.clientX-a.clientX,d=b.clientY-a.clientY;return Math.sqrt(c*c+d*d)}function m(a){document.removeEventListener("mousemove",e,!1);document.removeEventListener("mouseup",m,!1);k.domElement.removeEventListener("touchmove",f,!1);k.domElement.removeEventListener("touchend",g,!1);p=n.NONE}function g(a){1<a.changedTouches.length||m({type:"mouseup",view:a.view,bubbles:a.bubbles,cancelable:a.cancelable,
detail:a.detail,screenX:a.changedTouches[0].screenX,screenY:a.changedTouches[0].screenY,clientX:a.changedTouches[0].clientX,clientY:a.changedTouches[0].clientY,pageX:a.changedTouches[0].pageX,pageY:a.changedTouches[0].pageY,button:0,preventDefault:function(){}})}function l(a){a.preventDefault();if(!1!==k.enabled&&!1!==k.userZoom){var b=0;a.wheelDelta?b=a.wheelDelta:a.detail&&(b=-a.detail);0<b?k.zoomIn():k.zoomOut()}}this.object=a;this.domElement=void 0!==b?b:document;this.enabled=!0;this.center=new THREE.Vector3;
this.userZoom=!0;this.userZoomSpeed=1;this.userRotate=!0;this.userRotateSpeed=1;this.userPan=!0;this.userPanSpeed=2;this.autoRotate=!1;this.autoRotateSpeed=2;this.minPolarAngle=0;this.maxPolarAngle=Math.PI;this.minDistance=0;this.maxDistance=Infinity;this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40};this.oneButton=!1;var k=this,r=1800,q=new THREE.Vector2,x=new THREE.Vector2,y=new THREE.Vector2,w=new THREE.Vector2,z=new THREE.Vector2,A=new THREE.Vector2,s=0,t=0,u=1,B=new THREE.Vector3,n={NONE:-1,ROTATE:0,
ZOOM:1,PAN:2},p=n.NONE,C={type:"change"};this.rotateLeft=function(a){void 0===a&&(a=c());t-=a};this.rotateRight=function(a){void 0===a&&(a=c());t+=a};this.rotateUp=function(a){void 0===a&&(a=c());s-=a};this.rotateDown=function(a){void 0===a&&(a=c());s+=a};this.zoomIn=function(a){void 0===a&&(a=Math.pow(1/0.95,k.userZoomSpeed));u/=a};this.zoomOut=function(a){void 0===a&&(a=Math.pow(1/0.95,k.userZoomSpeed));u*=a};this.pan=function(a){a.transformDirection(this.object.matrix);a.multiplyScalar(k.userPanSpeed);
this.object.position.add(a);this.center.add(a)};this.update=function(){var a=this.object.position,b=a.clone().sub(this.center),d=Math.atan2(b.x,b.z),e=Math.atan2(Math.sqrt(b.x*b.x+b.z*b.z),b.y);this.autoRotate&&this.rotateLeft(c());var d=d+t,e=e+s,e=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,e)),e=Math.max(1E-6,Math.min(Math.PI-1E-6,e)),f=b.length()*u,f=Math.max(this.minDistance,Math.min(this.maxDistance,f));b.x=f*Math.sin(e)*Math.sin(d);b.y=f*Math.cos(e);b.z=f*Math.sin(e)*Math.cos(d);
a.copy(this.center).add(b);this.object.lookAt(this.center);s=t=0;u=1;0<B.distanceTo(this.object.position)&&(this.dispatchEvent(C),B.copy(this.object.position))};this.domElement.addEventListener("contextmenu",function(a){a.preventDefault()},!1);this.domElement.addEventListener("mousedown",d,!1);this.domElement.addEventListener("touchstart",function(a){1<a.touches.length?(k.touchDistance=h(a.touches[0],a.touches[1]),k.touchId0=a.touches[0].identifier,k.touchId1=a.touches[1].identifier):d({type:"mousedown",
view:a.view,bubbles:a.bubbles,cancelable:a.cancelable,detail:a.detail,screenX:a.touches[0].screenX,screenY:a.touches[0].screenY,clientX:a.touches[0].clientX,clientY:a.touches[0].clientY,pageX:a.touches[0].pageX,pageY:a.touches[0].pageY,button:0,preventDefault:function(){}})},!1);this.domElement.addEventListener("mousewheel",l,!1);this.domElement.addEventListener("DOMMouseScroll",l,!1);this.domElement.addEventListener("keydown",function(a){if(!1!==k.enabled&&!1!==k.userPan)switch(a.keyCode){case k.keys.UP:k.pan(new THREE.Vector3(0,
1,0));break;case k.keys.BOTTOM:k.pan(new THREE.Vector3(0,-1,0));break;case k.keys.LEFT:k.pan(new THREE.Vector3(-1,0,0));break;case k.keys.RIGHT:k.pan(new THREE.Vector3(1,0,0))}},!1)};Vizi.OrbitControls.prototype=Object.create(THREE.EventDispatcher.prototype);Vizi.GraphicsThreeJS=function(){Vizi.Graphics.call(this)};goog.inherits(Vizi.GraphicsThreeJS,Vizi.Graphics);Vizi.GraphicsThreeJS.prototype.initialize=function(a){a=a||{};this.initOptions(a);this.initPageElements(a);this.initScene();this.initRenderer(a);this.initMouse();this.initKeyboard();this.addDomHandlers()};Vizi.GraphicsThreeJS.prototype.focus=function(){this.renderer&&this.renderer.domElement&&this.renderer.domElement.focus()};
Vizi.GraphicsThreeJS.prototype.initOptions=function(a){this.displayStats=a&&a.displayStats?a.displayStats:Vizi.GraphicsThreeJS.default_display_stats};
Vizi.GraphicsThreeJS.prototype.initPageElements=function(a){a.container?this.container=a.container:(this.container=document.createElement("div"),document.body.appendChild(this.container));this.saved_cursor=this.container.style.cursor;this.displayStats&&(window.Stats?(a=new Stats,a.domElement.style.position="absolute",a.domElement.style.top="0px",a.domElement.style.left="0px",a.domElement.style.height="40px",this.container.appendChild(a.domElement),this.stats=a):Vizi.System.warn("No Stats module found. Make sure to include stats.min.js"))};
Vizi.GraphicsThreeJS.prototype.initScene=function(){var a=new THREE.Scene,b=new THREE.PerspectiveCamera(45,this.container.offsetWidth/this.container.offsetHeight,1,1E4);b.position.copy(Vizi.Camera.DEFAULT_POSITION);a.add(b);this.scene=a;this.camera=b;this.backgroundLayer={};a=new THREE.Scene;b=new THREE.PerspectiveCamera(45,this.container.offsetWidth/this.container.offsetHeight,0.01,1E4);b.position.set(0,0,10);a.add(b);this.backgroundLayer.scene=a;this.backgroundLayer.camera=b};
Vizi.GraphicsThreeJS.prototype.initRenderer=function(a){var b=new THREE.WebGLRenderer({antialias:void 0!==a.antialias?a.antialias:!0,alpha:void 0!==a.alpha?a.alpha:!0});b.sortObjects=!1;b.setSize(this.container.offsetWidth,this.container.offsetHeight);a&&a.backgroundColor&&(b.domElement.style.backgroundColor=a.backgroundColor,b.domElement.setAttribute("z-index",-1));this.container.appendChild(b.domElement);var c=new THREE.Projector;this.renderer=b;this.projector=c;this.lastFrameTime=0;a.riftRender&&
(this.riftCam=new THREE.VREffect(this.renderer,function(a){a&&console.log("Error creating VR renderer: ",a)}));this.composer=null};
Vizi.GraphicsThreeJS.prototype.initMouse=function(){var a=this.renderer.domElement,b=this;a.addEventListener("mousemove",function(a){b.onDocumentMouseMove(a)},!1);a.addEventListener("mousedown",function(a){b.onDocumentMouseDown(a)},!1);a.addEventListener("mouseup",function(a){b.onDocumentMouseUp(a)},!1);a.addEventListener("click",function(a){b.onDocumentMouseClick(a)},!1);a.addEventListener("dblclick",function(a){b.onDocumentMouseDoubleClick(a)},!1);a.addEventListener("mousewheel",function(a){b.onDocumentMouseScroll(a)},
!1);a.addEventListener("DOMMouseScroll",function(a){b.onDocumentMouseScroll(a)},!1);a.addEventListener("touchstart",function(a){b.onDocumentTouchStart(a)},!1);a.addEventListener("touchmove",function(a){b.onDocumentTouchMove(a)},!1);a.addEventListener("touchend",function(a){b.onDocumentTouchEnd(a)},!1)};
Vizi.GraphicsThreeJS.prototype.initKeyboard=function(){var a=this.renderer.domElement,b=this;a.addEventListener("keydown",function(a){b.onKeyDown(a)},!1);a.addEventListener("keyup",function(a){b.onKeyUp(a)},!1);a.addEventListener("keypress",function(a){b.onKeyPress(a)},!1);a.setAttribute("tabindex",1)};Vizi.GraphicsThreeJS.prototype.addDomHandlers=function(){var a=this;window.addEventListener("resize",function(b){a.onWindowResize(b)},!1)};
Vizi.GraphicsThreeJS.prototype.objectFromMouse=function(a){a=new THREE.Vector3(2*(a.elementX/this.container.offsetWidth)-1,2*-(a.elementY/this.container.offsetHeight)+1,0.5);this.projector.unprojectVector(a,this.camera);var b=new THREE.Vector3,b=b.applyMatrix4(this.camera.matrixWorld);a=(new THREE.Raycaster(b,a.sub(b).normalize())).intersectObjects(this.scene.children,!0);if(0<a.length){for(b=0;b<a.length&&(!a[b].object.visible||a[b].object.ignorePick);)b++;var c=a[b];return b>=a.length?{object:null,
point:null,normal:null}:this.findObjectFromIntersected(c.object,c.point,c.face)}return{object:null,point:null,normal:null}};
Vizi.GraphicsThreeJS.prototype.objectFromRay=function(a,b,c,d,e){b=new THREE.Raycaster(b,c,d,e);c=null;c=a?a.transform.object.children:this.scene.children;a=b.intersectObjects(c,!0);if(0<a.length){for(b=0;b<a.length&&(!a[b].object.visible||a[b].object.ignoreCollision);)b++;c=a[b];return b>=a.length?{object:null,point:null,normal:null}:this.findObjectFromIntersected(c.object,c.point,c.face)}return{object:null,point:null,normal:null}};
Vizi.GraphicsThreeJS.prototype.findObjectFromIntersected=function(a,b,c){if(a.data){var d=b.clone(),e=new THREE.Matrix4;e.getInverse(a.matrixWorld);b.applyMatrix4(e);return{object:a.data,point:b,hitPointWorld:d,face:c,normal:c?c.normal:null}}return a.parent?this.findObjectFromIntersected(a.parent,b,c):{object:null,point:null,face:null,normal:null}};
Vizi.GraphicsThreeJS.prototype.nodeFromMouse=function(a){a=new THREE.Vector3(2*(a.elementX/this.container.offsetWidth)-1,2*-(a.elementY/this.container.offsetHeight)+1,0.5);this.projector.unprojectVector(a,this.camera);var b=new THREE.Vector3,b=b.applyMatrix4(this.camera.matrixWorld);a=(new THREE.Raycaster(b,a.sub(b).normalize())).intersectObjects(this.scene.children,!0);if(0<a.length){for(b=0;!a[b].object.visible;)b++;return(a=a[b])?{node:a.object,point:a.point,normal:a.face.normal}:null}return null};
Vizi.GraphicsThreeJS.prototype.getObjectIntersection=function(a,b,c){a=new THREE.Vector3(2*(a/this.renderer.domElement.offsetWidth)-1,2*-(b/this.renderer.domElement.offsetHeight)+1,0.5);this.projector.unprojectVector(a,this.camera);b=new THREE.Vector3;b=b.applyMatrix4(this.camera.matrixWorld);c=(new THREE.Raycaster(b,a.sub(b).normalize())).intersectObject(c,!0);return c.length?(c=c[0],a=new THREE.Matrix4,a.getInverse(c.object.matrixWorld),c.point.applyMatrix4(a),c):null};
Vizi.GraphicsThreeJS.prototype.calcElementOffset=function(a){a.left=this.renderer.domElement.offsetLeft;a.top=this.renderer.domElement.offsetTop;for(var b=this.renderer.domElement.offsetParent;b;)a.left+=b.offsetLeft,a.top+=b.offsetTop,b=b.offsetParent};
Vizi.GraphicsThreeJS.prototype.onDocumentMouseMove=function(a){a.preventDefault();var b={};this.calcElementOffset(b);a={type:a.type,pageX:a.pageX,pageY:a.pageY,elementX:a.pageX-b.left,elementY:a.pageY-b.top,button:a.button,altKey:a.altKey,ctrlKey:a.ctrlKey,shiftKey:a.shiftKey};Vizi.Mouse.instance.onMouseMove(a);Vizi.PickManager&&Vizi.PickManager.handleMouseMove(a);Vizi.Application.handleMouseMove(a)};
Vizi.GraphicsThreeJS.prototype.onDocumentMouseDown=function(a){a.preventDefault();var b={};this.calcElementOffset(b);a={type:a.type,pageX:a.pageX,pageY:a.pageY,elementX:a.pageX-b.left,elementY:a.pageY-b.top,button:a.button,altKey:a.altKey,ctrlKey:a.ctrlKey,shiftKey:a.shiftKey};Vizi.Mouse.instance.onMouseDown(a);Vizi.PickManager&&Vizi.PickManager.handleMouseDown(a);Vizi.Application.handleMouseDown(a)};
Vizi.GraphicsThreeJS.prototype.onDocumentMouseUp=function(a){a.preventDefault();var b={};this.calcElementOffset(b);a={type:a.type,pageX:a.pageX,pageY:a.pageY,elementX:a.pageX-b.left,elementY:a.pageY-b.top,button:a.button,altKey:a.altKey,ctrlKey:a.ctrlKey,shiftKey:a.shiftKey};Vizi.Mouse.instance.onMouseUp(a);Vizi.PickManager&&Vizi.PickManager.handleMouseUp(a);Vizi.Application.handleMouseUp(a)};
Vizi.GraphicsThreeJS.prototype.onDocumentMouseClick=function(a){a.preventDefault();var b={};this.calcElementOffset(b);a={type:a.type,pageX:a.pageX,pageY:a.pageY,elementX:a.pageX-b.left,elementY:a.pageY-b.top,button:a.button,altKey:a.altKey,ctrlKey:a.ctrlKey,shiftKey:a.shiftKey};Vizi.Mouse.instance.onMouseClick(a);Vizi.PickManager&&Vizi.PickManager.handleMouseClick(a);Vizi.Application.handleMouseClick(a)};
Vizi.GraphicsThreeJS.prototype.onDocumentMouseDoubleClick=function(a){a.preventDefault();var b={};this.calcElementOffset(b);var c=a.pageX-b.left,d=a.pageY-b.top,c=a.pageX-b.left,d=a.pageY-b.top;a={type:a.type,pageX:a.pageX,pageY:a.pageY,elementX:c,elementY:d,button:a.button,altKey:a.altKey,ctrlKey:a.ctrlKey,shiftKey:a.shiftKey};Vizi.Mouse.instance.onMouseDoubleClick(a);Vizi.PickManager&&Vizi.PickManager.handleMouseDoubleClick(a);Vizi.Application.handleMouseDoubleClick(a)};
Vizi.GraphicsThreeJS.prototype.onDocumentMouseScroll=function(a){a.preventDefault();var b=0;a.wheelDelta?b=a.wheelDelta:a.detail&&(b=-a.detail);a={type:"mousescroll",delta:b};Vizi.Mouse.instance.onMouseScroll(a);Vizi.PickManager&&Vizi.PickManager.handleMouseScroll(a);Vizi.Application.handleMouseScroll(a)};
Vizi.GraphicsThreeJS.prototype.translateTouch=function(a,b){return{screenX:a.screenX,screenY:a.screenY,clientX:a.clientX,clientY:a.clientY,pageX:a.pageX,pageY:a.pageY,elementX:a.pageX-b.left,elementY:a.pageY-b.top}};
Vizi.GraphicsThreeJS.prototype.onDocumentTouchStart=function(a){a.preventDefault();var b={};this.calcElementOffset(b);var c=[],d,e=a.touches.length;for(d=0;d<e;d++)c.push(this.translateTouch(a.touches[d],b));a={type:a.type,touches:c};Vizi.PickManager&&Vizi.PickManager.handleTouchStart(a);Vizi.Application.handleTouchStart(a)};
Vizi.GraphicsThreeJS.prototype.onDocumentTouchMove=function(a){a.preventDefault();var b={};this.calcElementOffset(b);var c=[],d,e=a.touches.length;for(d=0;d<e;d++)c.push(this.translateTouch(a.touches[d],b));var f=[],e=a.changedTouches.length;for(d=0;d<e;d++)f.push(this.translateTouch(a.changedTouches[d],b));a={type:a.type,touches:c,changedTouches:f};Vizi.PickManager&&Vizi.PickManager.handleTouchMove(a);Vizi.Application.handleTouchMove(a)};
Vizi.GraphicsThreeJS.prototype.onDocumentTouchEnd=function(a){a.preventDefault();var b={};this.calcElementOffset(b);var c=[],d,e=a.touches.length;for(d=0;d<e;d++)c.push(this.translateTouch(a.touches[d],b));var f=[],e=a.changedTouches.length;for(d=0;d<e;d++)f.push(this.translateTouch(a.changedTouches[d],b));a={type:a.type,touches:c,changedTouches:f};Vizi.PickManager&&Vizi.PickManager.handleTouchEnd(a);Vizi.Application.handleTouchEnd(a)};
Vizi.GraphicsThreeJS.prototype.onKeyDown=function(a){a.preventDefault();Vizi.Keyboard.instance.onKeyDown(a);Vizi.Application.handleKeyDown(a)};Vizi.GraphicsThreeJS.prototype.onKeyUp=function(a){a.preventDefault();Vizi.Keyboard.instance.onKeyUp(a);Vizi.Application.handleKeyUp(a)};Vizi.GraphicsThreeJS.prototype.onKeyPress=function(a){a.preventDefault();Vizi.Keyboard.instance.onKeyPress(a);Vizi.Application.handleKeyPress(a)};
Vizi.GraphicsThreeJS.prototype.onWindowResize=function(a){this.renderer.setSize(this.container.offsetWidth,this.container.offsetHeight);Vizi.CameraManager&&Vizi.CameraManager.handleWindowResize(this.container.offsetWidth,this.container.offsetHeight)||(this.camera.aspect=this.container.offsetWidth/this.container.offsetHeight,this.camera.updateProjectionMatrix())};Vizi.GraphicsThreeJS.prototype.setCursor=function(a){a||(a=this.saved_cursor);this.container.style.cursor=a};
Vizi.GraphicsThreeJS.prototype.update=function(){var a=Date.now(),b=(a-this.lastFrameTime)/1E3;this.frameRate=1/b;this.lastFrameTime=a;this.riftCam&&this.riftCam._vrHMD?this.renderVR():this.composer?this.renderEffects(b):this.render();this.stats&&this.stats.update()};
Vizi.GraphicsThreeJS.prototype.render=function(){this.renderer.setClearColor(0,0);this.renderer.autoClearColor=!0;this.renderer.render(this.backgroundLayer.scene,this.backgroundLayer.camera);this.renderer.setClearColor(0,1);this.renderer.autoClearColor=!1;this.renderer.render(this.scene,this.camera)};Vizi.GraphicsThreeJS.prototype.renderVR=function(){this.riftCam.render([this.backgroundLayer.scene,this.scene],[this.backgroundLayer.camera,this.camera])};
Vizi.GraphicsThreeJS.prototype.renderEffects=function(a){this.composer.render(a)};Vizi.GraphicsThreeJS.prototype.enableShadows=function(a){this.renderer.shadowMapEnabled=a;this.renderer.shadowMapSoft=a;this.renderer.shadowMapCullFrontFaces=!1};Vizi.GraphicsThreeJS.prototype.setFullScreen=function(a){this.riftCam&&this.riftCam.setFullScreen(a)};Vizi.GraphicsThreeJS.prototype.setCamera=function(a){this.camera=a;this.composer&&this.composer.setCamera(a)};
Vizi.GraphicsThreeJS.prototype.addEffect=function(a){this.composer||(this.composer=new Vizi.Composer);this.effects||(this.effects=[]);if(a.isShaderEffect)for(var b=0;b<this.effects.length;b++);this.effects.push(a);this.composer.addEffect(a)};Vizi.GraphicsThreeJS.default_display_stats=!1;Vizi.TweenService=function(){};goog.inherits(Vizi.TweenService,Vizi.Service);Vizi.TweenService.prototype.initialize=function(a){};Vizi.TweenService.prototype.terminate=function(){};Vizi.TweenService.prototype.update=function(){window.TWEEN&&TWEEN.update()};Vizi.Services={};Vizi.Services._serviceMap={time:{object:Vizi.Time},input:{object:Vizi.Input},tween:{object:Vizi.TweenService},events:{object:Vizi.EventService},graphics:{object:Vizi.GraphicsThreeJS}};
Vizi.Services.create=function(a){var b=Vizi.Services._serviceMap[a];if(b){if(Vizi.Services[a])throw Error("Cannot create two "+a+" service instances");if(b.object)return b=new b.object,Vizi.Services[a]=b;throw Error("No object type supplied for creating service "+a+"; cannot create");}throw Error("Unknown service: "+a+"; cannot create");};
Vizi.Services.registerService=function(a,b){if(Vizi.Services._serviceMap[a])throw Error("Service "+a+"already registered; cannot register twice");Vizi.Services._serviceMap[a]={object:b}};Vizi.Application=function(a){Vizi.EventDispatcher.call(this);Vizi.Application.instance=this;this.initialize(a)};goog.inherits(Vizi.Application,Vizi.EventDispatcher);Vizi.Application.prototype.initialize=function(a){a=a||{};this.running=!1;this.tabstop=a.tabstop;this._services=[];this._objects=[];this.addService("time");this.addService("input");this.addOptionalServices();this.addService("tween");this.addService("events");this.addService("graphics");this.initServices(a)};
Vizi.Application.prototype.addService=function(a){a=Vizi.Services.create(a);this._services.push(a)};Vizi.Application.prototype.initServices=function(a){var b,c;c=this._services.length;for(b=0;b<c;b++)this._services[b].initialize(a)};Vizi.Application.prototype.addOptionalServices=function(){};Vizi.Application.prototype.focus=function(){Vizi.Graphics.instance.focus()};Vizi.Application.prototype.run=function(){this.realizeObjects();this.lastFrameTime=Date.now();this.running=!0;this.runloop()};
Vizi.Application.prototype.runloop=function(){var a=Date.now();a-this.lastFrameTime>=Vizi.Application.minFrameTime&&(this.updateServices(),this.lastFrameTime=a);var b=this;requestAnimationFrame(function(){b.runloop()})};Vizi.Application.prototype.updateServices=function(){var a,b;b=this._services.length;for(a=0;a<b;a++)this._services[a].update()};Vizi.Application.prototype.updateObjects=function(){var a,b=this._objects.length;for(a=0;a<b;a++)this._objects[a].update()};
Vizi.Application.prototype.addObject=function(a){this._objects.push(a);this.running&&a.realize()};Vizi.Application.prototype.removeObject=function(a){a=this._objects.indexOf(a);-1!=a&&this._objects.splice(a,1)};Vizi.Application.prototype.realizeObjects=function(){var a,b=this._objects.length;for(a=0;a<b;a++)this._objects[a].realize()};Vizi.Application.prototype.onMouseMove=function(a){if(this.mouseDelegate&&this.mouseDelegate.onMouseMove)this.mouseDelegate.onMouseMove(a)};
Vizi.Application.prototype.onMouseDown=function(a){if(this.mouseDelegate&&this.mouseDelegate.onMouseDown)this.mouseDelegate.onMouseDown(a)};Vizi.Application.prototype.onMouseUp=function(a){if(this.mouseDelegate&&this.mouseDelegate.onMouseUp)this.mouseDelegate.onMouseUp(a)};Vizi.Application.prototype.onMouseClick=function(a){if(this.mouseDelegate&&this.mouseDelegate.onMouseClick)this.mouseDelegate.onMouseClick(a)};Vizi.Application.prototype.onMouseDoubleClick=function(a){if(this.mouseDelegate&&this.mouseDelegate.onMouseDoubleClick)this.mouseDelegate.onMouseDoubleClick(a)};
Vizi.Application.prototype.onMouseScroll=function(a){if(this.mouseDelegate&&this.mouseDelegate.onMouseScroll)this.mouseDelegate.onMouseScroll(a)};Vizi.Application.prototype.onKeyDown=function(a){if(this.keyboardDelegate&&this.keyboardDelegate.onKeyDown)this.keyboardDelegate.onKeyDown(a)};Vizi.Application.prototype.onKeyUp=function(a){if(this.keyboardDelegate&&this.keyboardDelegate.onKeyUp)this.keyboardDelegate.onKeyUp(a)};
Vizi.Application.prototype.onKeyPress=function(a){if(this.keyboardDelegate&&this.keyboardDelegate.onKeyPress)this.keyboardDelegate.onKeyPress(a)};Vizi.Application.instance=null;Vizi.Application.curObjectID=0;Vizi.Application.minFrameTime=1;Vizi.Application.handleMouseMove=function(a){if((!Vizi.PickManager||!Vizi.PickManager.clickedObject)&&Vizi.Application.instance.onMouseMove)Vizi.Application.instance.onMouseMove(a)};
Vizi.Application.handleMouseDown=function(a){Vizi.Application.instance.tabstop&&Vizi.Application.instance.focus();if((!Vizi.PickManager||!Vizi.PickManager.clickedObject)&&Vizi.Application.instance.onMouseDown)Vizi.Application.instance.onMouseDown(a)};Vizi.Application.handleMouseUp=function(a){if((!Vizi.PickManager||!Vizi.PickManager.clickedObject)&&Vizi.Application.instance.onMouseUp)Vizi.Application.instance.onMouseUp(a)};
Vizi.Application.handleMouseClick=function(a){if((!Vizi.PickManager||!Vizi.PickManager.clickedObject)&&Vizi.Application.instance.onMouseClick)Vizi.Application.instance.onMouseClick(a)};Vizi.Application.handleMouseDoubleClick=function(a){if((!Vizi.PickManager||!Vizi.PickManager.clickedObject)&&Vizi.Application.instance.onMouseDoubleClick)Vizi.Application.instance.onMouseDoubleClick(a)};Vizi.Application.handleMouseScroll=function(a){if((!Vizi.PickManager||!Vizi.PickManager.overObject)&&Vizi.Application.instance.onMouseScroll)Vizi.Application.instance.onMouseScroll(a)};
Vizi.Application.handleTouchStart=function(a){if((!Vizi.PickManager||!Vizi.PickManager.clickedObject)&&Vizi.Application.instance.onTouchStart)Vizi.Application.instance.onTouchStart(a)};Vizi.Application.handleTouchMove=function(a){if((!Vizi.PickManager||!Vizi.PickManager.clickedObject)&&Vizi.Application.instance.onTouchMove)Vizi.Application.instance.onTouchMove(a)};Vizi.Application.handleTouchEnd=function(a){if((!Vizi.PickManager||!Vizi.PickManager.clickedObject)&&Vizi.Application.instance.onTouchEnd)Vizi.Application.instance.onTouchEnd(a)};
Vizi.Application.handleKeyDown=function(a){if(Vizi.Application.instance.onKeyDown)Vizi.Application.instance.onKeyDown(a)};Vizi.Application.handleKeyUp=function(a){if(Vizi.Application.instance.onKeyUp)Vizi.Application.instance.onKeyUp(a)};Vizi.Application.handleKeyPress=function(a){if(Vizi.Application.instance.onKeyPress)Vizi.Application.instance.onKeyPress(a)};Vizi.Application.prototype.onTouchMove=function(a){if(this.touchDelegate&&this.touchDelegate.onTouchMove)this.touchDelegate.onTouchMove(a)};
Vizi.Application.prototype.onTouchStart=function(a){if(this.touchDelegate&&this.touchDelegate.onTouchStart)this.touchDelegate.onTouchStart(a)};Vizi.Application.prototype.onTouchEnd=function(a){if(this.touchDelegate&&this.touchDelegate.onTouchEnd)this.touchDelegate.onTouchEnd(a)};Vizi.AnimationService=function(){};goog.inherits(Vizi.AnimationService,Vizi.Service);Vizi.AnimationService.prototype.initialize=function(a){};Vizi.AnimationService.prototype.terminate=function(){};Vizi.AnimationService.prototype.update=function(){window.TWEEN&&THREE.glTFAnimator.update()};Vizi.Prefabs.ModelController=function(a){a=a||{};var b=new Vizi.Object(a),c=new Vizi.ModelControllerScript(a);b.addComponent(c);a=new Vizi.DirectionalLight({intensity:a.headlight?1:0});b.addComponent(a);return b};
Vizi.ModelControllerScript=function(a){Vizi.Script.call(this,a);this.radius=a.radius||Vizi.ModelControllerScript.default_radius;this.minRadius=a.minRadius||Vizi.ModelControllerScript.default_min_radius;this.minAngle=void 0!==a.minAngle?a.minAngle:Vizi.ModelControllerScript.default_min_angle;this.maxAngle=void 0!==a.maxAngle?a.maxAngle:Vizi.ModelControllerScript.default_max_angle;this.minDistance=void 0!==a.minDistance?a.minDistance:Vizi.ModelControllerScript.default_min_distance;this.maxDistance=
void 0!==a.maxDistance?a.maxDistance:Vizi.ModelControllerScript.default_max_distance;this.allowPan=void 0!==a.allowPan?a.allowPan:!0;this.allowZoom=void 0!==a.allowZoom?a.allowZoom:!0;this.allowRotate=void 0!==a.allowRotate?a.allowRotate:!0;this.oneButton=void 0!==a.oneButton?a.oneButton:!0;this._enabled=void 0!==a.enabled?a.enabled:!0;this._headlightOn=a.headlight;this.cameras=[];this.controlsList=[];Object.defineProperties(this,{camera:{get:function(){return this._camera},set:function(a){this.setCamera(a)}},
center:{get:function(){return this.controls.center},set:function(a){this.controls.center.copy(a)}},enabled:{get:function(){return this._enabled},set:function(a){this.setEnabled(a)}},headlightOn:{get:function(){return this._headlightOn},set:function(a){this.setHeadlightOn(a)}}})};goog.inherits(Vizi.ModelControllerScript,Vizi.Script);Vizi.ModelControllerScript.prototype.realize=function(){this.headlight=this._object.getComponent(Vizi.DirectionalLight);this.headlight.intensity=this._headlightOn?1:0};
Vizi.ModelControllerScript.prototype.createControls=function(a){a=new Vizi.OrbitControls(a.object,Vizi.Graphics.instance.container);a.userMinY=this.minY;a.userMinZoom=this.minZoom;a.userMaxZoom=this.maxZoom;a.minPolarAngle=this.minAngle;a.maxPolarAngle=this.maxAngle;a.minDistance=this.minDistance;a.maxDistance=this.maxDistance;a.oneButton=this.oneButton;a.userPan=this.allowPan;a.userZoom=this.allowZoom;a.userRotate=this.allowRotate;a.enabled=this._enabled;return a};
Vizi.ModelControllerScript.prototype.update=function(){this.controls.update();this._headlightOn&&this.headlight.direction.copy(this._camera.position).negate()};Vizi.ModelControllerScript.prototype.setCamera=function(a){this._camera=a;this._camera.position.set(0,this.radius/2,this.radius);this.controls=this.createControls(a)};Vizi.ModelControllerScript.prototype.setHeadlightOn=function(a){this._headlightOn=a;this.headlight&&(this.headlight.intensity=a?1:0)};
Vizi.ModelControllerScript.prototype.setEnabled=function(a){this._enabled=a;this.controls.enabled=a};Vizi.ModelControllerScript.default_radius=10;Vizi.ModelControllerScript.default_min_radius=1;Vizi.ModelControllerScript.default_min_angle=0;Vizi.ModelControllerScript.default_max_angle=Math.PI;Vizi.ModelControllerScript.default_min_distance=0;Vizi.ModelControllerScript.default_max_distance=Infinity;Vizi.ModelControllerScript.MAX_X_ROTATION=0;Vizi.ModelControllerScript.MIN_X_ROTATION=-Math.PI/2;
Vizi.ModelControllerScript.MAX_Y_ROTATION=2*Math.PI;Vizi.ModelControllerScript.MIN_Y_ROTATION=2*-Math.PI;Vizi.Prefabs.Skybox=function(a){a=a||{};var b=new Vizi.Object({layer:Vizi.Graphics.instance.backgroundLayer}),c=THREE.ShaderLib.cube;c.uniforms.tCube.value=null;c=new THREE.ShaderMaterial({fragmentShader:c.fragmentShader,vertexShader:c.vertexShader,uniforms:c.uniforms,side:THREE.BackSide});c=new Vizi.Visual({geometry:new THREE.CubeGeometry(1E4,1E4,1E4),material:c});b.addComponent(c);a=new Vizi.SkyboxScript(a);b.addComponent(a);b.realize();return b};
Vizi.SkyboxScript=function(a){Vizi.Script.call(this,a);this.maincampos=new THREE.Vector3;this.maincamrot=new THREE.Quaternion;this.maincamscale=new THREE.Vector3;Object.defineProperties(this,{texture:{get:function(){return this.uniforms.tCube.value},set:function(a){this.uniforms.tCube.value=a}}})};goog.inherits(Vizi.SkyboxScript,Vizi.Script);
Vizi.SkyboxScript.prototype.realize=function(){this.uniforms=this._object.getComponent(Vizi.Visual).material.uniforms;this.camera=Vizi.Graphics.instance.backgroundLayer.camera;this.camera.far=2E4;this.camera.position.set(0,0,0)};Vizi.SkyboxScript.prototype.update=function(){var a=Vizi.Graphics.instance.camera;a.updateMatrixWorld();a.matrixWorld.decompose(this.maincampos,this.maincamrot,this.maincamscale);this.camera.quaternion.copy(this.maincamrot)};Vizi.Prefabs.Skysphere=function(a){a=a||{};var b=new Vizi.Object({layer:Vizi.Graphics.instance.backgroundLayer}),c=new THREE.MeshBasicMaterial({color:16777215}),d=new THREE.SphereGeometry(500,32,32);d.applyMatrix((new THREE.Matrix4).makeScale(-1,1,1));c=new Vizi.Visual({geometry:d,material:c});b.addComponent(c);a=new Vizi.SkysphereScript(a);b.addComponent(a);b.realize();return b};
Vizi.SkysphereScript=function(a){Vizi.Script.call(this,a);this.maincampos=new THREE.Vector3;this.maincamrot=new THREE.Quaternion;this.maincamscale=new THREE.Vector3;Object.defineProperties(this,{texture:{get:function(){return this.material.map},set:function(a){this.material.map=a}}})};goog.inherits(Vizi.SkysphereScript,Vizi.Script);
Vizi.SkysphereScript.prototype.realize=function(){this.material=this._object.getComponent(Vizi.Visual).material;this.camera=Vizi.Graphics.instance.backgroundLayer.camera;this.camera.far=2E4;this.camera.position.set(0,0,0)};Vizi.SkysphereScript.prototype.update=function(){var a=Vizi.Graphics.instance.camera;a.updateMatrixWorld();a.matrixWorld.decompose(this.maincampos,this.maincamrot,this.maincamscale);this.camera.quaternion.copy(this.maincamrot)};Vizi.KeyFrameAnimator=function(a){Vizi.Component.call(this,a);a=a||{};this.interpdata=a.interps||[];this.animationData=a.animations;this.running=!1;this.direction=Vizi.KeyFrameAnimator.FORWARD_DIRECTION;this.duration=a.duration?a.duration:Vizi.KeyFrameAnimator.default_duration;this.loop=a.loop?a.loop:!1;this.easing=a.easing};goog.inherits(Vizi.KeyFrameAnimator,Vizi.Component);
Vizi.KeyFrameAnimator.prototype.realize=function(){Vizi.Component.prototype.realize.call(this);this.interpdata&&this.createInterpolators(this.interpdata);if(this.animationData){this.animations=[];var a,b=this.animationData.length;for(a=0;a<b;a++){var c=this.animationData[a];c instanceof THREE.glTFAnimation||(THREE.AnimationHandler.add(c),c=new THREE.KeyFrameAnimation(c.node,c.name));this.animations.push(c)}}};
Vizi.KeyFrameAnimator.prototype.createInterpolators=function(a){this.interps=[];var b,c=a.length;for(b=0;b<c;b++){var d=a[b],d=new Vizi.Interpolator({keys:d.keys,values:d.values,target:d.target});d.realize();this.interps.push(d)}};
Vizi.KeyFrameAnimator.prototype.start=function(){if(!this.running&&(this.lastTime=this.startTime=Date.now(),this.running=!0,this.animations)){var a,b=this.animations.length;for(a=0;a<b;a++)this.animations[a].loop=this.loop,this.animations[a]instanceof THREE.glTFAnimation&&(this.animations[a].direction=this.direction==Vizi.KeyFrameAnimator.FORWARD_DIRECTION?THREE.glTFAnimation.FORWARD_DIRECTION:THREE.glTFAnimation.REVERSE_DIRECTION),this.animations[a].play(this.loop,0),this.endTime=this.startTime+
this.animations[a].endTime/this.animations[a].timeScale,isNaN(this.endTime)&&(this.endTime=this.startTime+1E3*this.animations[a].duration)}};Vizi.KeyFrameAnimator.prototype.stop=function(){this.running=!1;this.dispatchEvent("complete");if(this.animations){var a,b=this.animations.length;for(a=0;a<b;a++)this.animations[a].stop()}};
Vizi.KeyFrameAnimator.prototype.update=function(){if(this.running)if(this.animations)this.updateAnimations();else{var a=Date.now(),b=Math.floor((a-this.startTime)/this.duration),a=(a-this.startTime)%this.duration/this.duration;this.easing&&(a=this.easing(a));if(1<=b&&!this.loop){this.running=!1;this.dispatchEvent("complete");for(var c=this.interps.length,b=0;b<c;b++)this.interps[b].interp(1)}else for(c=this.interps.length,b=0;b<c;b++)this.interps[b].interp(a)}};
Vizi.KeyFrameAnimator.prototype.updateAnimations=function(){var a=Date.now(),b=a-this.lastTime,c=!1,d,e=this.animations.length;for(d=0;d<e;d++)this.animations[d].update(b),!this.loop&&a>=this.endTime&&(c=!0);this.lastTime=a;c&&this.stop()};Vizi.KeyFrameAnimator.default_duration=1E3;Vizi.KeyFrameAnimator.FORWARD_DIRECTION=0;Vizi.KeyFrameAnimator.REVERSE_DIRECTION=1;Vizi.Prefabs.RiftController=function(a){a=a||{};var b=new Vizi.Object(a);a=new Vizi.RiftControllerScript(a);b.addComponent(a);return b};Vizi.RiftControllerScript=function(a){Vizi.Script.call(this,a);this._enabled=void 0!==a.enabled?a.enabled:!0;this.riftControls=null;Object.defineProperties(this,{camera:{get:function(){return this._camera},set:function(a){this.setCamera(a)}},enabled:{get:function(){return this._enabled},set:function(a){this.setEnabled(a)}}})};
goog.inherits(Vizi.RiftControllerScript,Vizi.Script);Vizi.RiftControllerScript.prototype.realize=function(){};Vizi.RiftControllerScript.prototype.update=function(){this._enabled&&this.riftControls&&this.riftControls.update()};Vizi.RiftControllerScript.prototype.setEnabled=function(a){this._enabled=a};Vizi.RiftControllerScript.prototype.setCamera=function(a){this._camera=a;this.riftControls=this.createControls(a)};
Vizi.RiftControllerScript.prototype.createControls=function(a){return new THREE.VRControls(a.object,function(a){a&&console.log("Error creating VR controller: ",a)})};Vizi.Interpolator=function(a){Vizi.EventDispatcher.call(a);a=a||{};this.keys=a.keys||[];this.values=a.values||[];this.target=a.target?a.target:null;this.running=!1};goog.inherits(Vizi.Interpolator,Vizi.EventDispatcher);Vizi.Interpolator.prototype.realize=function(){this.keys&&this.values&&this.setValue(this.keys,this.values)};Vizi.Interpolator.prototype.setValue=function(a,b){this.keys=[];this.values=[];a&&(a.length&&b&&b.length)&&(this.copyKeys(a,this.keys),this.copyValues(b,this.values))};
Vizi.Interpolator.prototype.copyKeys=function(a,b){for(var c=0,d=a.length,c=0;c<d;c++)b[c]=a[c]};Vizi.Interpolator.prototype.copyValues=function(a,b){for(var c=0,d=a.length,c=0;c<d;c++){var e={};this.copyValue(a[c],e);b[c]=e}};Vizi.Interpolator.prototype.copyValue=function(a,b){for(var c in a)null!==a[c]&&(b[c]=a[c])};
Vizi.Interpolator.prototype.interp=function(a){var b,c,d=this.keys.length;a==this.keys[0]?b=this.values[0]:a>=this.keys[d-1]&&(b=this.values[d-1]);for(c=0;c<d-1;c++){var e=this.keys[c],f=this.keys[c+1];a>=e&&a<=f&&(b=this.tween(this.values[c],this.values[c+1],(a-e)/(f-e)))}this.target?this.copyValue(b,this.target):this.publish("value",b)};Vizi.Interpolator.prototype.tween=function(a,b,c){var d={},e;for(e in a)null!==a[e]&&(d[e]=a[e]+(b[e]-a[e])*c);return d};Vizi.Prefabs.PointerLockController=function(a){a=a||{};var b=new Vizi.Object(a),c=new Vizi.PointerLockControllerScript(a);b.addComponent(c);a=new Vizi.DirectionalLight({intensity:a.headlight?1:0});b.addComponent(a);return b};
Vizi.PointerLockControllerScript=function(a){Vizi.Script.call(this,a);this._enabled=void 0!==a.enabled?a.enabled:!0;this._move=void 0!==a.move?a.move:!0;this._look=void 0!==a.look?a.look:!0;this._turn=void 0!==a.turn?a.turn:!0;this._tilt=void 0!==a.tilt?a.tilt:!0;this._mouseLook=void 0!==a.mouseLook?a.mouseLook:!1;this.collisionDistance=10;this.moveSpeed=13;this.tiltSpeed=this.turnSpeed=5;this.lookSpeed=1;this.savedCameraPos=new THREE.Vector3;this.movementVector=new THREE.Vector3;Object.defineProperties(this,
{camera:{get:function(){return this._camera},set:function(a){this.setCamera(a)}},enabled:{get:function(){return this._enabled},set:function(a){this.setEnabled(a)}},move:{get:function(){return this._move},set:function(a){this.setMove(a)}},look:{get:function(){return this._look},set:function(a){this.setLook(a)}},mouseLook:{get:function(){return this._mouseLook},set:function(a){this.setMouseLook(a)}},headlightOn:{get:function(){return this._headlightOn},set:function(a){this.setHeadlightOn(a)}}})};
goog.inherits(Vizi.PointerLockControllerScript,Vizi.Script);Vizi.PointerLockControllerScript.prototype.realize=function(){this.headlight=this._object.getComponent(Vizi.DirectionalLight);this.headlight.intensity=this._headlightOn?1:0};
Vizi.PointerLockControllerScript.prototype.createControls=function(a){a=new Vizi.PointerLockControls(a.object,Vizi.Graphics.instance.container);a.mouseLook=this._mouseLook;a.movementSpeed=this._move?this.moveSpeed:0;a.lookSpeed=this._look?this.lookSpeed:0;a.turnSpeed=this._turn?this.turnSpeed:0;a.tiltSpeed=this._tilt?this.tiltSpeed:0;this.clock=new THREE.Clock;return a};
Vizi.PointerLockControllerScript.prototype.update=function(){this.saveCamera();this.controls.update(this.clock.getDelta());var a=this.testCollision();a&&a.object&&(this.restoreCamera(),this.dispatchEvent("collide",a));this.testTerrain()&&this.restoreCamera();this._headlightOn&&this.headlight.direction.copy(this._camera.position).negate()};Vizi.PointerLockControllerScript.prototype.setEnabled=function(a){this._enabled=a;this.controls.enabled=a};
Vizi.PointerLockControllerScript.prototype.setMove=function(a){this._move=a;this.controls.movementSpeed=a?this.moveSpeed:0};Vizi.PointerLockControllerScript.prototype.setLook=function(a){this._look=a;this.controls.lookSpeed=a?1:0};Vizi.PointerLockControllerScript.prototype.setMouseLook=function(a){this._mouseLook=a;this.controls.mouseLook=a};
Vizi.PointerLockControllerScript.prototype.setCamera=function(a){this._camera=a;this.controls=this.createControls(a);this.controls.movementSpeed=this.moveSpeed;this.controls.lookSpeed=this._look?0.1:0};Vizi.PointerLockControllerScript.prototype.saveCamera=function(){this.savedCameraPos.copy(this._camera.position)};Vizi.PointerLockControllerScript.prototype.restoreCamera=function(){this._camera.position.copy(this.savedCameraPos)};
Vizi.PointerLockControllerScript.prototype.testCollision=function(){this.movementVector.copy(this._camera.position).sub(this.savedCameraPos);if(this.movementVector.length()){var a=Vizi.Graphics.instance.objectFromRay(null,this.savedCameraPos,this.movementVector,1,2);a&&a.object&&this.savedCameraPos.distanceTo(a.hitPointWorld);return a}return null};Vizi.PointerLockControllerScript.prototype.testTerrain=function(){return!1};
Vizi.PointerLockControllerScript.prototype.setHeadlightOn=function(a){this._headlightOn=a;this.headlight&&(this.headlight.intensity=a?1:0)};Vizi.PerspectiveCamera=function(a){a=a||{};if(a.object)this.object=a.object;else{var b=a.fov||45,c=a.near||Vizi.Camera.DEFAULT_NEAR,d=a.far||Vizi.Camera.DEFAULT_FAR,e=Vizi.Graphics.instance.container,e=a.aspect||e.offsetWidth/e.offsetHeight;this.updateProjection=!1;this.object=new THREE.PerspectiveCamera(b,e,c,d)}Object.defineProperties(this,{fov:{get:function(){return this.object.fov},set:function(a){this.object.fov=a;this.updateProjection=!0}},aspect:{get:function(){return this.object.aspect},set:function(a){this.object.aspect=
a;this.updateProjection=!0}},near:{get:function(){return this.object.near},set:function(a){this.object.near=a;this.updateProjection=!0}},far:{get:function(){return this.object.far},set:function(a){this.object.far=a;this.updateProjection=!0}}});Vizi.Camera.call(this,a)};goog.inherits(Vizi.PerspectiveCamera,Vizi.Camera);Vizi.PerspectiveCamera.prototype.realize=function(){Vizi.Camera.prototype.realize.call(this)};
Vizi.PerspectiveCamera.prototype.update=function(){this.updateProjection&&(this.object.updateProjectionMatrix(),this.updateProjection=!1)};Vizi.Helpers={};Vizi.Helpers.BoundingBoxDecoration=function(a){a=a||{};if(!a.object)return Vizi.warn("Vizi.Helpers.BoundingBoxDecoration requires an object"),null;var b=void 0!==a.color?a.color:8947848;a=Vizi.SceneUtils.computeBoundingBox(a.object);var c=a.max.x-a.min.x,d=a.max.y-a.min.y,e=a.max.z-a.min.z,f=new THREE.BoxHelper;f.material.color.setHex(b);f.scale.set(c/2,d/2,e/2);b=new Vizi.Decoration({object:f});a=a.max.clone().add(a.min).multiplyScalar(0.5);b.position.add(a);return b};
Vizi.Helpers.VectorDecoration=function(a){a=a||{};var b=a.start||new THREE.Vector3,c=a.end||new THREE.Vector3(0,1,0),d=void 0!==a.color?a.color:8947848;a=new THREE.Geometry;a.vertices.push(b,c);b=new THREE.LineBasicMaterial({color:d});b=new THREE.Line(a,b);return new Vizi.Decoration({object:b})};
Vizi.Helpers.PlaneDecoration=function(a){a=a||{};if(!a.normal&&!a.triangle)return Vizi.warn("Vizi.Helpers.PlaneDecoration requires either a normal or three coplanar points"),null;var b=a.normal;if(!b)return Vizi.warn("Vizi.Helpers.PlaneDecoration creating plane from coplanar points not implemented yet"),null;var c=a.position||new THREE.Vector3,d=a.size||1;a=void 0!==a.color?a.color:8947848;var e=(new THREE.Vector3(0,b.z,-b.y)).normalize().multiplyScalar(d),f=e.clone().cross(b).normalize().multiplyScalar(d),
d=c.clone().sub(e).sub(f),h=c.clone().add(e).sub(f),m=c.clone().add(e).add(f),e=c.clone().sub(e).add(f),c=new THREE.Geometry;c.vertices.push(d,h,m,e);d=new THREE.Face3(0,1,2);d.normal.copy(b);d.vertexNormals.push(b.clone(),b.clone(),b.clone(),b.clone());c.faces.push(d);d=new THREE.Face3(0,2,3);d.normal.copy(b);d.vertexNormals.push(b.clone(),b.clone(),b.clone(),b.clone());c.faces.push(d);c.computeFaceNormals();c.computeCentroids();b=new THREE.MeshBasicMaterial({color:a,transparent:!0,side:THREE.DoubleSide,
opacity:0.1});b=new THREE.Mesh(c,b);return new Vizi.Decoration({object:b})};Vizi.SceneUtils={};
Vizi.SceneUtils.computeBoundingBox=function(a){var b=function(a){if(a instanceof THREE.Mesh&&!a.ignoreBounds){var d=a.geometry;return d?(d.boundingBox||d.computeBoundingBox(),d=d.boundingBox.clone(),a.updateMatrix(),d.applyMatrix4(a.matrix),d):new THREE.Box3(new THREE.Vector3,new THREE.Vector3)}for(var e=a.children.length,f=new THREE.Box3,d=0;d<e;d++){var h=b(a.children[d]);h.min.x<f.min.x&&(f.min.x=h.min.x);h.max.x>f.max.x&&(f.max.x=h.max.x);h.min.y<f.min.y&&(f.min.y=h.min.y);h.max.y>f.max.y&&(f.max.y=
h.max.y);h.min.z<f.min.z&&(f.min.z=h.min.z);h.max.z>f.max.z&&(f.max.z=h.max.z)}isFinite(f.min.x)&&(a.updateMatrix(),f.applyMatrix4(a.matrix));return f};return a instanceof Vizi.Object?b(a.transform.object):a instanceof Vizi.Visual?b(a.object):new THREE.Box3(new THREE.Vector3,new THREE.Vector3)};Vizi.OculusRiftControls=function(a){var b=this,c=!1,d=!1,e=!1,f=!1,h=!1,m=!1,g=new THREE.Vector3;this.moveSpeed=0.03;this.jumpSpeed=2;var l=new THREE.Quaternion,k=new THREE.Vector3(1,0,0),r=new THREE.Vector3(0,0,1),q=function(a){switch(a.keyCode){case 38:case 87:c=!0;break;case 37:case 65:e=!0;break;case 40:case 83:d=!0;break;case 39:case 68:f=!0;break;case 32:!0===m&&(g.y+=this.jumpSpeed),m=!1}}.bind(this);document.addEventListener("mousemove",function(c){if(!1!==b.enabled){var d=c.movementX||c.mozMovementX||
c.webkitMovementX||0;c=c.movementY||c.mozMovementY||c.webkitMovementY||0;console.log(d,c);l.setFromAxisAngle(r,0.002*d);a.quaternion.multiplySelf(l);l.setFromAxisAngle(k,0.002*c);a.quaternion.multiplySelf(l)}},!1);document.addEventListener("keydown",q,!1);document.addEventListener("keyup",function(a){switch(a.keyCode){case 38:case 87:c=!1;break;case 37:case 65:e=!1;break;case 40:case 83:d=!1;break;case 39:case 68:f=!1}},!1);this.enabled=!1;this.getObject=function(){return a};this.isOnObject=function(a){m=
h=a};this.update=function(b,k){b*=0.1;g.x+=0.08*-g.x*b;g.z+=0.08*-g.z*b;g.y-=0.1*b;c&&(g.z-=this.moveSpeed*b);d&&(g.z+=this.moveSpeed*b);e&&(g.x-=this.moveSpeed*b);f&&(g.x+=this.moveSpeed*b);!0===h&&(g.y=Math.max(0,g.y));var l=new THREE.Quaternion;new THREE.Euler;k&&(l.set(k.hmd.rotation[0],k.hmd.rotation[1],k.hmd.rotation[2],k.hmd.rotation[3]),0==l.x&&0==l.y&&0==l.z&&0==l.w||a.quaternion.copy(l));10>a.position.y&&(g.y=0,m=!0)}};Vizi.System={log:function(){var a=["[Vizi] "].concat([].slice.call(arguments));console.log.apply(console,a)},warn:function(){var a=["[Vizi] "].concat([].slice.call(arguments));console.warn.apply(console,a)},error:function(){var a=["[Vizi] "].concat([].slice.call(arguments));console.error.apply(console,a)}};Vizi.HighlightBehavior=function(a){a=a||{};this.highlightColor=void 0!==a.highlightColor?a.highlightColor:16777215;this.savedColors=[];Vizi.Behavior.call(this,a)};goog.inherits(Vizi.HighlightBehavior,Vizi.Behavior);Vizi.HighlightBehavior.prototype.start=function(){Vizi.Behavior.prototype.start.call(this);if(this._realized&&this._object.visuals){var a=this._object.visuals,b,c=a.length;for(b=0;b<c;b++)this.savedColors.push(a[b].material.color.getHex()),a[b].material.color.setHex(this.highlightColor)}};
Vizi.HighlightBehavior.prototype.evaluate=function(a){};Vizi.HighlightBehavior.prototype.stop=function(){Vizi.Behavior.prototype.stop.call(this);if(this._realized&&this._object.visuals){var a=this._object.visuals,b,c=a.length;for(b=0;b<c;b++)a[b].material.color.setHex(this.savedColors[b])}};Vizi.HighlightBehavior.prototype.on=Vizi.HighlightBehavior.prototype.start;Vizi.HighlightBehavior.prototype.off=Vizi.HighlightBehavior.prototype.stop;Vizi.BounceBehavior=function(a){a=a||{};this.duration=void 0!==a.duration?a.duration:1;this.bounceVector=void 0!==a.bounceVector?a.bounceVector:new THREE.Vector3(0,1,0);this.tweenDown=this.tweenUp=null;Vizi.Behavior.call(this,a)};goog.inherits(Vizi.BounceBehavior,Vizi.Behavior);
Vizi.BounceBehavior.prototype.start=function(){this.running||(this.bouncePosition=new THREE.Vector3,this.bounceEndPosition=this.bounceVector.clone(),this.prevBouncePosition=new THREE.Vector3,this.bounceDelta=new THREE.Vector3,this.tweenUp=(new TWEEN.Tween(this.bouncePosition)).to(this.bounceEndPosition,1E3*(this.duration/2)).easing(TWEEN.Easing.Quadratic.InOut).repeat(0).start(),Vizi.Behavior.prototype.start.call(this))};
Vizi.BounceBehavior.prototype.evaluate=function(a){this.bounceDelta.copy(this.bouncePosition).sub(this.prevBouncePosition);this.prevBouncePosition.copy(this.bouncePosition);this._object.transform.position.add(this.bounceDelta);a>=this.duration/2&&(this.tweenUp&&(this.tweenUp.stop(),this.tweenUp=null),this.tweenDown||(this.bouncePosition=this._object.transform.position.clone(),this.bounceEndPosition=this.bouncePosition.clone().sub(this.bounceVector),this.prevBouncePosition=this.bouncePosition.clone(),
this.bounceDelta=new THREE.Vector3,this.tweenDown=(new TWEEN.Tween(this.bouncePosition)).to(this.bounceEndPosition,1E3*(this.duration/2)).easing(TWEEN.Easing.Quadratic.InOut).repeat(0).start()));a>=this.duration&&(this.tweenDown.stop(),this.tweenDown=null,this.stop(),this.loop&&this.start())};Vizi.CameraManager={};Vizi.CameraManager.addCamera=function(a){Vizi.CameraManager.cameraList.push(a)};Vizi.CameraManager.removeCamera=function(a){a=Vizi.CameraManager.cameraList.indexOf(a);-1!=a&&Vizi.CameraManager.cameraList.splice(a,1)};Vizi.CameraManager.setActiveCamera=function(a){Vizi.CameraManager.activeCamera&&Vizi.CameraManager.activeCamera!=a&&(Vizi.CameraManager.activeCamera.active=!1);Vizi.CameraManager.activeCamera=a;Vizi.Graphics.instance.setCamera(a.object)};
Vizi.CameraManager.handleWindowResize=function(a,b){var c=Vizi.CameraManager.cameraList;if(0==c.length)return!1;var d,e=c.length;for(d=0;d<e;d++)c[d].aspect=a/b;return!0};Vizi.CameraManager.cameraList=[];Vizi.CameraManager.activeCamera=null;Vizi.Prefabs.HUD=function(a){a=a||{};var b=new Vizi.Object;a=new Vizi.HUDScript(a);b.addComponent(a);return b};Vizi.HUDScript=function(a){Vizi.Script.call(this,a);this.zDistance=void 0!==a.zDistance?a.zDistance:Vizi.HUDScript.DEFAULT_Z_DISTANCE;this.position=new THREE.Vector3(0,0,-this.zDistance);this.savedPosition=this.position.clone();this.scale=new THREE.Vector3;this.quaternion=new THREE.Quaternion};goog.inherits(Vizi.HUDScript,Vizi.Script);Vizi.HUDScript.prototype.realize=function(){};
Vizi.HUDScript.EPSILON=0.001;Vizi.HUDScript.prototype.update=function(){var a=Vizi.Graphics.instance.camera;a.updateMatrixWorld();a.matrixWorld.decompose(this.position,this.quaternion,this.scale);this._object.transform.quaternion.copy(this.quaternion);this._object.transform.position.copy(this.position);this._object.transform.translateZ(-this.zDistance);this.savedPosition.distanceTo(this.position)>Vizi.HUDScript.EPSILON&&console.log("Position changed:",this.position);this.savedPosition.copy(this.position)};
Vizi.HUDScript.DEFAULT_Z_DISTANCE=1;Vizi.Loader=function(){Vizi.EventDispatcher.call(this)};goog.inherits(Vizi.Loader,Vizi.EventDispatcher);Vizi.Loader.prototype.loadModel=function(a,b){var c=a.split("."),d=c.length,e="";d&&(e=c[d-1]);if(e&&e.length){var f;switch(e.toUpperCase()){case "JS":f=THREE.JSONLoader}if(f){var h=this;(new f).load(a,function(c,d){h.handleModelLoaded(a,b,c,d)})}}};
Vizi.Loader.prototype.handleModelLoaded=function(a,b,c,d){a=new THREE.MeshFaceMaterial(d);a=new THREE.Mesh(c,a);c=new Vizi.Object;a=new Vizi.Visual({object:a});c.addComponent(a);this.dispatchEvent("loaded",{scene:c,cameras:[],lights:[],keyFrameAnimators:[],userData:b})};
Vizi.Loader.prototype.loadScene=function(a,b){var c=a.split("."),d=c.length,e="";d&&(e=c[d-1]);if(e&&e.length){var f;switch(e.toUpperCase()){case "DAE":f=THREE.ColladaLoader;break;case "JS":return this.loadModel(a,b);case "JSON":f=THREE.glTFLoader}if(f){var h=this;(new f).load(a,function(c){h.handleSceneLoaded(a,c,b)},function(b){h.handleSceneProgress(a,b)})}}};
Vizi.Loader.prototype.traverseCallback=function(a,b){a instanceof THREE.Camera&&(b.cameras||(b.cameras=[]),b.cameras.push(a));a instanceof THREE.Light&&(b.lights||(b.lights=[]),b.lights.push(a))};
Vizi.Loader.prototype.handleSceneLoaded=function(a,b,c){var d={},e=!1;b.scene&&(console.log("In loaded callback for ",a),e=this.convertScene(b.scene),d.scene=e,d.cameras=e.findNodes(Vizi.Camera),d.lights=e.findNodes(Vizi.Light),d.url=a,d.userData=c,e=!0);if(b.animations)for(d.keyFrameAnimators=[],c=b.animations.length,a=0;a<c;a++){var f=[];f.push(b.animations[a]);d.keyFrameAnimators.push(new Vizi.KeyFrameAnimator({animations:f}))}e&&this.dispatchEvent("loaded",d)};
Vizi.Loader.prototype.handleSceneProgress=function(a,b){this.dispatchEvent("progress",b)};
Vizi.Loader.prototype.convertScene=function(a){function b(a){if(a instanceof THREE.Mesh){a.matrixAutoUpdate=!0;a.geometry.dynamic=!0;var d=new Vizi.Visual({object:a});d.name=a.name;return d}if(a instanceof THREE.Camera){if(a instanceof THREE.PerspectiveCamera)return new Vizi.PerspectiveCamera({object:a})}else if(a instanceof THREE.Light){if(a instanceof THREE.AmbientLight)return new Vizi.AmbientLight({object:a});if(a instanceof THREE.DirectionalLight)return new Vizi.DirectionalLight({object:a});if(a instanceof
THREE.PointLight)return new Vizi.PointLight({object:a});if(a instanceof THREE.SpotLight)return new Vizi.SpotLight({object:a})}else if(a.children){d=new Vizi.Object({autoCreateTransform:!1});d.addComponent(new Vizi.Transform({object:a}));d.name=a.name;a.matrixAutoUpdate=!0;var e,f=a.children.length;for(e=0;e<f;e++){var h=b(a.children[e]);h instanceof Vizi.Object?d.addChild(h):h instanceof Vizi.Component&&d.addComponent(h)}}return d}a.updateMatrixWorld();return b(a)};Vizi.ParticleEmitter=function(a){this.param=a||{};Vizi.Component.call(this,a);a=this.param.size||Vizi.ParticleEmitter.DEFAULT_SIZE;var b=this.param.sizeEnd||Vizi.ParticleEmitter.DEFAULT_SIZE_END,c=this.param.colorStart||Vizi.ParticleEmitter.DEFAULT_COLOR_START,d=this.param.colorEnd||Vizi.ParticleEmitter.DEFAULT_COLOR_END,e=this.param.particlesPerSecond||Vizi.ParticleEmitter.DEFAULT_PARTICLES_PER_SECOND,f=this.param.opacityStart||Vizi.ParticleEmitter.DEFAULT_OPACITY_START,h=this.param.opacityMiddle||
Vizi.ParticleEmitter.DEFAULT_OPACITY_MIDDLE,m=this.param.opacityEnd||Vizi.ParticleEmitter.DEFAULT_OPACITY_END,g=this.param.velocity||Vizi.ParticleEmitter.DEFAULT_VELOCITY,l=this.param.acceleration||Vizi.ParticleEmitter.DEFAULT_ACCELERATION,k=this.param.positionSpread||Vizi.ParticleEmitter.DEFAULT_POSITION_SPREAD,r=this.param.accelerationSpread||Vizi.ParticleEmitter.DEFAULT_ACCELERATION_SPREAD,q=this.param.blending||Vizi.ParticleEmitter.DEFAULT_BLENDING;this._active=!1;this.object=new ShaderParticleEmitter({size:a,
sizeEnd:b,colorStart:c,colorEnd:d,particlesPerSecond:e,opacityStart:f,opacityMiddle:h,opacityEnd:m,velocity:g,acceleration:l,positionSpread:k,accelerationSpread:r,blending:q});Object.defineProperties(this,{active:{get:function(){return this._active},set:function(a){this.setActive(a)}}})};goog.inherits(Vizi.ParticleEmitter,Vizi.Component);Vizi.ParticleEmitter.prototype.realize=function(){};Vizi.ParticleEmitter.prototype.update=function(){};
Vizi.ParticleEmitter.prototype.setActive=function(a){(this._active=a)?this.object.enable():this.object.disable()};Vizi.ParticleEmitter.DEFAULT_SIZE=1;Vizi.ParticleEmitter.DEFAULT_SIZE_END=1;Vizi.ParticleEmitter.DEFAULT_COLOR_START=new THREE.Color;Vizi.ParticleEmitter.DEFAULT_COLOR_END=new THREE.Color;Vizi.ParticleEmitter.DEFAULT_PARTICLES_PER_SECOND=10;Vizi.ParticleEmitter.DEFAULT_OPACITY_START=0.1;Vizi.ParticleEmitter.DEFAULT_OPACITY_MIDDLE=0.5;Vizi.ParticleEmitter.DEFAULT_OPACITY_END=0;
Vizi.ParticleEmitter.DEFAULT_VELOCITY=new THREE.Vector3(0,10,0);Vizi.ParticleEmitter.DEFAULT_ACCELERATION=new THREE.Vector3(0,1,0);Vizi.ParticleEmitter.DEFAULT_POSITION_SPREAD=new THREE.Vector3(0,0,0);Vizi.ParticleEmitter.DEFAULT_ACCELERATION_SPREAD=new THREE.Vector3(0,1,0);Vizi.ParticleEmitter.DEFAULT_BLENDING=THREE.NoBlending;Vizi.Gamepad=function(){Vizi.EventDispatcher.call(this);this.controllers={};this.values={};Vizi.Gamepad.instance=this};goog.inherits(Vizi.Gamepad,Vizi.EventDispatcher);Vizi.Gamepad.prototype.update=function(){this.scanGamepads();var a={changedButtons:[]},b={changedAxes:[]},c;for(c in this.controllers){var d=this.controllers[c];this.testValues(d,a,b);this.saveValues(d)}a.changedButtons.length&&this.dispatchEvent("buttonsChanged",a);b.changedAxes.length&&this.dispatchEvent("axesChanged",b)};
Vizi.Gamepad.prototype.testValues=function(a,b,c){var d=this.values[a.index];if(d){for(var e=0;e<a.buttons.length;e++){var f=a.buttons[e],h=1==f;"object"==typeof f&&(h=f.pressed);h!=d.buttons[e]&&b.changedButtons.push({gamepad:a.index,button:e,pressed:h})}for(e=0;e<a.axes.length;e++)f=a.axes[e],f!=d.axes[e]&&c.changedAxes.push({gamepad:a.index,axis:e,value:f})}};
Vizi.Gamepad.prototype.saveValues=function(a){var b=this.values[a.index];if(b){for(var c=0;c<a.buttons.length;c++){var d=a.buttons[c],e=1==d;"object"==typeof d&&(e=d.pressed);b.buttons[c]=e}for(c=0;c<a.axes.length;c++)d=a.axes[c],b.axes[c]=d}};Vizi.Gamepad.prototype.addGamepad=function(a){this.controllers[a.index]=a;this.values[a.index]={buttons:[],axes:[]};this.saveValues(a);console.log("Gamepad added! ",a.id)};
Vizi.Gamepad.prototype.scanGamepads=function(){for(var a=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads():[],b=0;b<a.length;b++)a[b]&&(a[b].index in this.controllers?this.controllers[a[b].index]=a[b]:this.addGamepad(a[b]))};Vizi.Gamepad.instance=null;Vizi.Gamepad.BUTTON_A=Vizi.Gamepad.BUTTON_CROSS=0;Vizi.Gamepad.BUTTON_B=Vizi.Gamepad.BUTTON_CIRCLE=1;Vizi.Gamepad.BUTTON_X=Vizi.Gamepad.BUTTON_SQUARE=2;
Vizi.Gamepad.BUTTON_Y=Vizi.Gamepad.BUTTON_TRIANGLE=3;Vizi.Gamepad.SHOULDER_LEFT=4;Vizi.Gamepad.SHOULDER_RIGHT=5;Vizi.Gamepad.TRIGGER_LEFT=6;Vizi.Gamepad.TRIGGER_RIGHT=7;Vizi.Gamepad.SELECT=Vizi.Gamepad.BACK=8;Vizi.Gamepad.START=9;Vizi.Gamepad.STICK_LEFT=10;Vizi.Gamepad.STICK_RIGHT=11;Vizi.Gamepad.DPAD_UP=12;Vizi.Gamepad.DPAD_DOWN=13;Vizi.Gamepad.DPAD_LEFT=14;Vizi.Gamepad.DPAD_RIGHT=15;Vizi.Gamepad.HOME=Vizi.Gamepad.MENU=16;Vizi.Gamepad.AXIS_LEFT_H=0;Vizi.Gamepad.AXIS_LEFT_V=1;
Vizi.Gamepad.AXIS_RIGHT_H=2;Vizi.Gamepad.AXIS_RIGHT_V=3;Vizi.DeviceOrientationControls=function(a){function b(a,b){return function(){b.apply(a,arguments)}}this.object=a;this.object.rotation.reorder("YXZ");this.roll=this.freeze=!0;this.deviceOrientation={};this.screenOrientation=0;this.onDeviceOrientationChangeEvent=function(a){this.deviceOrientation=a};this.onScreenOrientationChangeEvent=function(){this.screenOrientation=window.orientation||0};this.update=function(){var a,b,e;return function(){this.freeze||(a=this.deviceOrientation.gamma?THREE.Math.degToRad(this.deviceOrientation.alpha):
0,b=this.deviceOrientation.beta?THREE.Math.degToRad(this.deviceOrientation.beta):0,e=this.deviceOrientation.gamma?THREE.Math.degToRad(this.deviceOrientation.gamma):0,orient=this.screenOrientation?THREE.Math.degToRad(this.screenOrientation):0,setObjectQuaternion(this.object.quaternion,a,b,e,orient))}}();this.connect=function(){this.onScreenOrientationChangeEvent();window.addEventListener("orientationchange",b(this,this.onScreenOrientationChangeEvent),!1);window.addEventListener("deviceorientation",
b(this,this.onDeviceOrientationChangeEvent),!1);this.freeze=!1};this.disconnect=function(){this.freeze=!0;window.removeEventListener("orientationchange",b(this,this.onScreenOrientationChangeEvent),!1);window.removeEventListener("deviceorientation",b(this,this.onDeviceOrientationChangeEvent),!1)};setObjectQuaternion=function(){var a=new THREE.Vector3(0,0,1),b=new THREE.Euler,e=new THREE.Quaternion,f=new THREE.Quaternion(-Math.sqrt(0.5),0,0,Math.sqrt(0.5));return function(h,m,g,l,k){this.roll||(Math.abs(k)==
Math.PI/2?g=0:k!=Math.PI&&(l=0));b.set(g,m,-l,"YXZ");h.setFromEuler(b);h.multiply(f);h.multiply(e.setFromAxisAngle(a,-k))}}()};Vizi.PlaneDragger=function(a){a=a||{};Vizi.Picker.call(this,a);this.normal=a.normal||new THREE.Vector3(0,0,1);this.position=a.position||new THREE.Vector3;this.color=170};goog.inherits(Vizi.PlaneDragger,Vizi.Picker);
Vizi.PlaneDragger.prototype.realize=function(){Vizi.Picker.prototype.realize.call(this);this.dragObject=null;this.dragOffset=new THREE.Vector3;this.dragHitPoint=new THREE.Vector3;this.dragStartPoint=new THREE.Vector3;this.dragPlane=this.createDragPlane();this.dragPlane.visible=Vizi.PlaneDragger.SHOW_DRAG_PLANE;this.dragPlane.ignorePick=!0;this.dragPlane.ignoreBounds=!0;this._object._parent.transform.object.add(this.dragPlane)};
Vizi.PlaneDragger.prototype.createDragPlane=function(){var a=this.normal,b=this.position,c=(new THREE.Vector3(0,a.z,-a.y)).normalize().multiplyScalar(2E3);c.lengthSq()||(c=(new THREE.Vector3(-a.z,a.x,0)).normalize().multiplyScalar(2E3));var d=c.clone().cross(a).normalize().multiplyScalar(2E3),e=b.clone().sub(c).sub(d),f=b.clone().add(c).sub(d),h=b.clone().add(c).add(d),c=b.clone().sub(c).add(d),b=new THREE.Geometry;b.vertices.push(e,f,h,c);e=new THREE.Face3(0,2,1);e.normal.copy(a);e.vertexNormals.push(a.clone(),
a.clone(),a.clone(),a.clone());b.faces.push(e);e=new THREE.Face3(0,3,2);e.normal.copy(a);e.vertexNormals.push(a.clone(),a.clone(),a.clone(),a.clone());b.faces.push(e);b.computeFaceNormals();a=new THREE.MeshBasicMaterial({color:this.color,transparent:!0,side:THREE.DoubleSide,opacity:0.1});return new THREE.Mesh(b,a)};Vizi.PlaneDragger.prototype.update=function(){};Vizi.PlaneDragger.prototype.onMouseMove=function(a){Vizi.Picker.prototype.onMouseMove.call(this,a);this.handleMouseMove(a)};
Vizi.PlaneDragger.prototype.handleMouseMove=function(a){if(a=Vizi.Graphics.instance.getObjectIntersection(a.elementX,a.elementY,this.dragPlane))this.dragHitPoint.copy(a.point).sub(this.dragOffset),this.dragHitPoint.add(this.dragStartPoint),this.dispatchEvent("drag",{type:"drag",object:this.dragObject,offset:this.dragHitPoint})};Vizi.PlaneDragger.prototype.onMouseDown=function(a){Vizi.Picker.prototype.onMouseDown.call(this,a);this.handleMouseDown(a)};
Vizi.PlaneDragger.prototype.handleMouseDown=function(a){var b=Vizi.Graphics.instance.getObjectIntersection(a.elementX,a.elementY,this.dragPlane);b&&(this.dragOffset.copy(b.point),this.dragStartPoint.copy(a.object.position),this.dragHitPoint.copy(b.point).sub(this.dragOffset),this.dragHitPoint.add(this.dragStartPoint),this.dragObject=a.object,this.dispatchEvent("dragstart",{type:"dragstart",object:this.dragObject,offset:this.dragHitPoint}))};
Vizi.PlaneDragger.prototype.onMouseUp=function(a){Vizi.Picker.prototype.onMouseUp.call(this,a);this.handleMouseUp(a)};Vizi.PlaneDragger.prototype.handleMouseUp=function(a){};Vizi.PlaneDragger.prototype.onTouchStart=function(a){Vizi.Picker.prototype.onTouchStart.call(this,a);this.handleMouseDown(a)};Vizi.PlaneDragger.prototype.onTouchMove=function(a){Vizi.Picker.prototype.onTouchMove.call(this,a);this.handleMouseMove(a)};
Vizi.PlaneDragger.prototype.onTouchEnd=function(a){Vizi.Picker.prototype.onTouchEnd.call(this,a);this.handleMouseUp(a)};Vizi.PlaneDragger.SHOW_DRAG_PLANE=!1;Vizi.PlaneDragger.SHOW_DRAG_NORMAL=!1;Vizi.ScaleBehavior=function(a){a=a||{};this.duration=void 0!==a.duration?a.duration:1;this.startScale=void 0!==a.startScale?a.startScale.clone():new THREE.Vector3(1,1,1);this.endScale=void 0!==a.endScale?a.endScale.clone():new THREE.Vector3(2,2,2);this.tween=null;Vizi.Behavior.call(this,a)};goog.inherits(Vizi.ScaleBehavior,Vizi.Behavior);
Vizi.ScaleBehavior.prototype.start=function(){this.running||(this.scale=this.startScale.clone(),this.originalScale=this._object.transform.scale.clone(),this.tween=(new TWEEN.Tween(this.scale)).to(this.endScale,1E3*this.duration).easing(TWEEN.Easing.Quadratic.InOut).repeat(0).start(),Vizi.Behavior.prototype.start.call(this))};
Vizi.ScaleBehavior.prototype.evaluate=function(a){a>=this.duration&&(this.stop(),this.loop?this.start():this.dispatchEvent("complete"));this._object.transform.scale.set(this.originalScale.x*this.scale.x,this.originalScale.y*this.scale.y,this.originalScale.z*this.scale.z)};Vizi.ScaleBehavior.prototype.stop=function(){this.tween&&this.tween.stop();Vizi.Behavior.prototype.stop.call(this)};Vizi.Composer=function(a){if(Vizi.Composer.instance)throw Error("Composer singleton already exists");Vizi.Composer.instance=this;a=Vizi.Graphics.instance;this.composer=new THREE.EffectComposer(a.renderer);this.composer.addPass(new THREE.RenderPass(a.scene,a.camera));a=new THREE.ShaderPass(THREE.CopyShader);a.renderToScreen=!0;this.composer.addPass(a)};Vizi.Composer.prototype.render=function(a){this.composer.render(a)};
Vizi.Composer.prototype.addEffect=function(a){this.composer.insertPass(a.pass,this.composer.passes.length-1)};Vizi.Composer.prototype.setCamera=function(a){this.composer.passes[0].camera=a};Vizi.Composer.instance=null;Vizi.Viewer=function(a){Vizi.Application.call(this,a);this.lastFPSUpdateTime=0;this.renderStats={fps:0};this.sceneStats={meshCount:0,faceCount:0,boundingBox:new THREE.Box3};this.renderStatsUpdateInterval=void 0!==a.renderStatsUpdateInterval?a.renderStatsUpdateInterval:1E3;this.loopAnimations=void 0!==a.loopAnimations?a.loopAnimations:!1;this.headlightOn=void 0!==a.headlight?a.headlight:!0;this.headlightIntensity=a.headlightIntensity||Vizi.Viewer.DEFAULT_HEADLIGHT_INTENSITY;this.riftController=void 0!==
a.riftController?a.riftController:!1;this.firstPerson=void 0!==a.firstPerson?a.firstPerson:!1;this.showGrid=void 0!==a.showGrid?a.showGrid:!1;this.createBoundingBoxes=void 0!==a.createBoundingBoxes?a.createBoundingBoxes:!1;this.showBoundingBoxes=void 0!==a.showBoundingBoxes?a.showBoundingBoxes:!1;this.allowPan=void 0!==a.allowPan?a.allowPan:!0;this.allowZoom=void 0!==a.allowZoom?a.allowZoom:!0;this.oneButton=void 0!==a.oneButton?a.oneButton:!1;this.gridSize=a.gridSize||Vizi.Viewer.DEFAULT_GRID_SIZE;
this.gridStepSize=a.gridStepSize||Vizi.Viewer.DEFAULT_GRID_STEP_SIZE;this.flipY=void 0!==a.flipY?a.flipY:!1;this.highlightDecoration=this.highlightedObject=null;this.initScene();Vizi.Graphics.instance.enableShadows(!0)};goog.inherits(Vizi.Viewer,Vizi.Application);
Vizi.Viewer.prototype.initScene=function(){this.sceneRoot=new Vizi.Object;this.addObject(this.sceneRoot);this.flipY&&(this.sceneRoot.transform.rotation.x=-Math.PI/2);this.gridRoot=new Vizi.Object;this.addObject(this.gridRoot);this.gridPicker=this.grid=null;this.createGrid();this.firstPerson?(this.controller=Vizi.Prefabs.FirstPersonController({active:!0,headlight:!0,turn:!this.riftController,look:!this.riftController}),this.controllerScript=this.controller.getComponent(Vizi.FirstPersonControllerScript)):
(this.controller=Vizi.Prefabs.ModelController({active:!0,headlight:!0,allowPan:this.allowPan,allowZoom:this.allowZoom,oneButton:this.oneButton}),this.controllerScript=this.controller.getComponent(Vizi.ModelControllerScript));this.addObject(this.controller);var a=new Vizi.Object;this.defaultCamera=new Vizi.PerspectiveCamera({active:!0});a.addComponent(this.defaultCamera);a.name="[default]";this.addObject(a);this.controllerScript.camera=this.defaultCamera;if(this.riftController){var a=Vizi.Prefabs.RiftController({active:!0,
headlight:!1,mouseLook:!1,useVRJS:!0}),b=a.getComponent(Vizi.RiftControllerScript);b.camera=this.defaultCamera;b.moveSpeed=6;this.riftControllerScript=b;this.addObject(a)}a=new Vizi.Object;this.ambientLight=new Vizi.AmbientLight({color:16777215,intensity:this.ambientOn?1:0});this.addObject(a);this.scenes=[];this.keyFrameAnimators=[];this.keyFrameAnimatorNames=[];this.cameras=[];this.cameraNames=[];this.lights=[];this.lightNames=[];this.lightIntensities=[];this.lightColors=[]};
Vizi.Viewer.prototype.runloop=function(){var a=this.renderStatsUpdateInterval;Vizi.Application.prototype.runloop.call(this);if(Vizi.Graphics.instance.frameRate){var b=Date.now();b-this.lastFPSUpdateTime>a&&(this.renderStats.fps=Vizi.Graphics.instance.frameRate,this.dispatchEvent("renderstats",this.renderStats),this.lastFPSUpdateTime=b)}};
Vizi.Viewer.prototype.replaceScene=function(a){var b,c=this.sceneRoot._children.length,d=[];for(b=0;b<c;b++)d.push(this.sceneRoot._children[b]);for(b=0;b<c;b++)this.sceneRoot.removeChild(d[b]);this.sceneRoot.removeComponent(this.sceneRoot.findNode(Vizi.Decoration));this.scenes=[a.scene];this.sceneRoot.addChild(a.scene);Vizi.SceneUtils.computeBoundingBox(a.scene);if(this.keyFrameAnimators){c=this.keyFrameAnimators.length;for(b=0;b<c;b++)this.sceneRoot.removeComponent(this.keyFrameAnimators[b]);this.keyFrameAnimators=
[];this.keyFrameAnimatorNames=[]}if(a.keyFrameAnimators)for(c=a.keyFrameAnimators.length,b=0;b<c;b++)this.sceneRoot.addComponent(a.keyFrameAnimators[b]),this.keyFrameAnimators.push(a.keyFrameAnimators[b]),this.keyFrameAnimatorNames.push(a.keyFrameAnimators[b].animationData[0].name);this.cameras=[];this.cameraNames=[];this.cameras.push(this.defaultCamera);this.camera=this.defaultCamera;this.cameraNames.push("[default]");this.controllerScript.camera=this.defaultCamera;this.controllerScript.camera.active=
!0;if(a.cameras)for(c=a.cameras.length,b=0;b<c;b++)d=a.cameras[b],d.aspect=container.offsetWidth/container.offsetHeight,this.cameras.push(d),this.cameraNames.push(d._object.name);this.lights=[];this.lightNames=[];this.lightIntensities=[];this.lightColors=[];if(a.lights){c=a.lights.length;for(b=0;b<c;b++)d=a.lights[b],d instanceof THREE.SpotLight&&(d.castShadow=!0,d.shadowCameraNear=1,d.shadowCameraFar=Vizi.Light.DEFAULT_RANGE,d.shadowCameraFov=90,d.shadowBias=1E-4,d.shadowDarkness=0.3,d.shadowMapWidth=
2048,d.shadowMapHeight=2048,d.target.position.set(0,0,0)),this.lights.push(a.lights[b]),this.lightNames.push(a.lights[b]._object.name),this.lightIntensities.push(a.lights[b].intensity),this.lightColors.push(a.lights[b].color.clone());this.controllerScript.headlight.intensity=c?0:this.headlightIntensity;this.headlightOn=0>=c}else this.controllerScript.headlight.intensity=this.headlightIntensity,this.headlightOn=!0;this.initHighlight();this.fitToScene();this.calcSceneStats()};
Vizi.Viewer.prototype.addToScene=function(a){this.sceneRoot.addChild(a.scene);this.cameras.length||(this.cameras=[],this.cameraNames=[],this.cameras.push(this.defaultCamera),this.camera=this.defaultCamera,this.cameraNames.push("[default]"),this.controllerScript.camera=this.defaultCamera,this.controllerScript.camera.active=!0);if(a.keyFrameAnimators){var b,c=a.keyFrameAnimators.length;for(b=0;b<c;b++)this.sceneRoot.addComponent(a.keyFrameAnimators[b]),this.keyFrameAnimators.push(a.keyFrameAnimators[b]),
this.keyFrameAnimatorNames.push(a.keyFrameAnimators[b].animationData[0].name)}if(a.cameras)for(c=a.cameras.length,b=0;b<c;b++){var d=a.cameras[b];d.aspect=container.offsetWidth/container.offsetHeight;this.cameras.push(d);this.cameraNames.push(d._object.name)}if(a.lights)for(c=a.lights.length,b=0;b<c;b++)d=a.lights[b],d instanceof THREE.SpotLight&&(d.castShadow=!0,d.shadowCameraNear=1,d.shadowCameraFar=Vizi.Light.DEFAULT_RANGE,d.shadowCameraFov=90,d.shadowBias=1E-4,d.shadowDarkness=0.3,d.shadowMapWidth=
2048,d.shadowMapHeight=2048,d.target.position.set(0,0,0)),this.lights.push(a.lights[b]),this.lightNames.push(a.lights[b]._object.name),this.lightIntensities.push(a.lights[b].intensity),this.lightColors.push(a.lights[b].color.clone());else this.lights.length||(this.controllerScript.headlight.intensity=this.headlightIntensity,this.headlightOn=!0);this.scenes.push(a.scene);this.initHighlight();this.fitToScene();this.calcSceneStats()};
Vizi.Viewer.prototype.createDefaultCamera=function(){var a=this.controllerScript.viewpoint.camera.object;a.updateMatrixWorld();var b=new THREE.Vector3,c=new THREE.Quaternion,d=new THREE.Vector3;a.matrixWorld.decompose(b,c,d);(new THREE.Euler).setFromQuaternion(c);a=new THREE.PerspectiveCamera(a.fov,a.aspect,a.near,a.far);return new Vizi.PerspectiveCamera({object:a})};
Vizi.Viewer.prototype.copyCameraValues=function(a,b){var c=a.object;c.updateMatrixWorld();var d=new THREE.Vector3,e=new THREE.Quaternion,f=new THREE.Vector3;c.matrixWorld.decompose(d,e,f);c=(new THREE.Euler).setFromQuaternion(e);b.position.copy(d);b.rotation.copy(c);b.fov=a.fov;b.aspect=a.aspect;b.near=a.near;b.far=a.far};
Vizi.Viewer.prototype.useCamera=function(a){var b=a;"string"==typeof a&&this.cameraNames&&(b=this.cameraNames.indexOf(a));0<=b&&(this.cameras&&this.cameras[b])&&(this.cameras[b].active=!0,this.controllerScript.enabled=0==b)};Vizi.Viewer.prototype.addCamera=function(a,b){this.cameras.push(a);this.cameraNames.push(b)};Vizi.Viewer.prototype.getCamera=function(a){var b=a;"string"==typeof a&&this.cameraNames&&(b=this.cameraNames.indexOf(a));return 0<=b&&this.cameras&&this.cameras[b]?this.cameras[b]:null};
Vizi.Viewer.prototype.toggleLight=function(a){if(this.lights&&this.lights[a]){var b=this.lights[a];b instanceof Vizi.AmbientLight?(b=b.color,0!=b.r||0!=b.g||0!=b.b?b.setRGB(0,0,0):b.copy(this.lightColors[a])):b.intensity=b.intensity?0:this.lightIntensities[a]}};
Vizi.Viewer.prototype.playAnimation=function(a,b,c){void 0===b&&(b=this.loopAnimations);this.keyFrameAnimators&&this.keyFrameAnimators[a]&&(this.keyFrameAnimators[a].loop=b,this.keyFrameAnimators[a].direction=c?Vizi.KeyFrameAnimator.REVERSE_DIRECTION:Vizi.KeyFrameAnimator.FORWARD_DIRECTION,b||this.keyFrameAnimators[a].stop(),this.keyFrameAnimators[a].start())};Vizi.Viewer.prototype.stopAnimation=function(a){this.keyFrameAnimators&&this.keyFrameAnimators[a]&&this.keyFrameAnimators[a].stop()};
Vizi.Viewer.prototype.playAllAnimations=function(a,b){void 0===a&&(a=this.loopAnimations);if(this.keyFrameAnimators){var c,d=this.keyFrameAnimators.length;for(c=0;c<d;c++)this.keyFrameAnimators[c].stop(),a&&(this.keyFrameAnimators[c].loop=!0),this.keyFrameAnimators[c].direction=b?Vizi.KeyFrameAnimator.REVERSE_DIRECTION:Vizi.KeyFrameAnimator.FORWARD_DIRECTION,this.keyFrameAnimators[c].start()}};
Vizi.Viewer.prototype.stopAllAnimations=function(){if(this.keyFrameAnimators){var a,b=this.keyFrameAnimators.length;for(a=0;a<b;a++)this.keyFrameAnimators[a].stop()}};Vizi.Viewer.prototype.setLoopAnimations=function(a){this.loopAnimations=a};Vizi.Viewer.prototype.setHeadlightOn=function(a){this.controllerScript.headlight.intensity=this.headlightIntensity?this.headlightIntensity:0;this.headlightOn=a};
Vizi.Viewer.prototype.setHeadlightIntensity=function(a){this.controllerScript.headlight.intensity=a};Vizi.Viewer.prototype.setGridOn=function(a){this.grid&&(this.grid.visible=a)};Vizi.Viewer.prototype.setBoundingBoxesOn=function(a){this.showBoundingBoxes=a;var b=this;this.sceneRoot.map(Vizi.Decoration,function(a){b.highlightedObject&&a==b.highlightDecoration||(a.visible=b.showBoundingBoxes)})};
Vizi.Viewer.prototype.setAmbientLightOn=function(a){this.ambientLight.intensity=a?1:0;this.ambientLightOn=a};Vizi.Viewer.prototype.setFlipY=function(a){(this.flipY=a)?(this.sceneRoot.transform.rotation.x=-Math.PI/2,this.fitToScene()):this.sceneRoot.transform.rotation.x=0};Vizi.Viewer.prototype.initHighlight=function(){this.highlightedObject&&this.highlightedObject.removeComponent(this.highlightDecoration);this.highlightedObject=null};
Vizi.Viewer.prototype.highlightObject=function(a){this.highlightedObject&&this.highlightParent.removeComponent(this.highlightDecoration);a?(this.highlightDecoration=Vizi.Helpers.BoundingBoxDecoration({object:a,color:11184640}),a instanceof Vizi.Object?(a._parent.addComponent(this.highlightDecoration),this.highlightedObject=a,this.highlightParent=a._parent):a instanceof Vizi.Visual&&(a._object.addComponent(this.highlightDecoration),this.highlightParent=this.highlightedObject=a._object)):this.highlightParent=
this.highlightedObject=null};
Vizi.Viewer.prototype.createGrid=function(){this.gridRoot&&(this.grid&&this.gridRoot.removeComponent(this.grid),this.gridPicker&&this.gridRoot.removeComponent(this.gridPicker));for(var a=this.gridStepSize,b=this.gridSize,c=new THREE.Geometry,d=0;d<=2*(b/a);d++)c.vertices.push(new THREE.Vector3(-b,-0.04,d*a-b)),c.vertices.push(new THREE.Vector3(b,-0.04,d*a-b)),c.vertices.push(new THREE.Vector3(d*a-b,-0.04,-b)),c.vertices.push(new THREE.Vector3(d*a-b,-0.04,b));a=new THREE.LineBasicMaterial({color:Vizi.Viewer.GRID_COLOR,opacity:Vizi.Viewer.GRID_OPACITY});
c=new THREE.Line(c,a,THREE.LinePieces);c.visible=this.showGrid;this.grid=new Vizi.Visual({object:c});this.gridRoot.addComponent(this.grid);this.gridPicker=new Vizi.Picker;var e=this;this.gridPicker.addEventListener("mouseup",function(a){e.highlightObject(null)});this.gridRoot.addComponent(this.gridPicker)};
Vizi.Viewer.prototype.fitToScene=function(){this.boundingBox=Vizi.SceneUtils.computeBoundingBox(this.sceneRoot);this.controllerScript.controls.userPanSpeed=1;1>this.boundingBox.max.z?(this.controllerScript.camera.near=0.01,this.controllerScript.controls.userPanSpeed=0.01):1E4<this.boundingBox.max.z?this.controllerScript.camera.far=2*this.boundingBox.max.z*Math.sqrt(2):1E3<this.boundingBox.max.z&&(this.controllerScript.camera.far=2E4);var a=this.boundingBox.max.clone().add(this.boundingBox.min).multiplyScalar(0.5);
this.controllerScript.center=a;1==this.scenes.length&&(a=new THREE.Vector3(0,this.boundingBox.max.y,2*this.boundingBox.max.z),this.controllerScript.camera.position.copy(a),this.controllerScript.camera.position.z*=2,this.cameras[0].position.copy(this.controllerScript.camera.position));if(this.createBoundingBoxes){var b=this;this.sceneRoot.map(Vizi.Object,function(a){if(a._parent){var d=Vizi.Helpers.BoundingBoxDecoration({object:a,color:65280});a._parent.addComponent(d);d.visible=b.showBoundingBoxes}})}this.sceneRadius=
this.boundingBox.max.clone().sub(this.boundingBox.min).length();this.gridSize=a=Math.pow(10,Math.ceil(Math.log(this.sceneRadius)/Math.LN10));this.gridStepSize=a/100;this.createGrid()};
Vizi.Viewer.prototype.calcSceneStats=function(){this.faceCount=this.meshCount=0;var a=this.sceneRoot.findNodes(Vizi.Visual),b,c=a.length;for(b=0;b<c;b++){var d=a[b].geometry;this.faceCount+=d.faces?d.faces.length:d.attributes.index.array.length/3;this.meshCount++}this.sceneStats.meshCount=this.meshCount;this.sceneStats.faceCount=this.faceCount;this.sceneStats.boundingBox=this.boundingBox;this.dispatchEvent("scenestats",this.sceneStats)};
Vizi.Viewer.prototype.setController=function(a){this.boundingBox||(this.boundingBox=Vizi.SceneUtils.computeBoundingBox(this.sceneRoot));var b;b=isFinite(this.boundingBox.max.x)?this.boundingBox.max.clone().add(this.boundingBox.min).multiplyScalar(0.5):new THREE.Vector3;switch(a){case "FPS":b.y=0}this.controllerScript.center=b};Vizi.Viewer.DEFAULT_GRID_SIZE=100;Vizi.Viewer.DEFAULT_GRID_STEP_SIZE=1;Vizi.Viewer.GRID_COLOR=2105376;Vizi.Viewer.GRID_OPACITY=0.2;Vizi.Viewer.DEFAULT_HEADLIGHT_INTENSITY=1;Vizi.ParticleSystem=function(a){a=a||{};var b=new Vizi.Object,c=a.texture||null,d=a.maxAge||Vizi.ParticleSystemScript.DEFAULT_MAX_AGE,e=null;if(a.geometry)c=new THREE.PointCloudMaterial({color:void 0!==a.color?a.color:Vizi.ParticleSystem.DEFAULT_COLOR,size:a.size,map:a.map,transparent:null!==a.map,vertexColors:0<a.geometry.colors.length}),c=new THREE.PointCloud(a.geometry,c),c.sortParticles=!0,a.map&&(c.sortParticles=!0),e=new Vizi.Visual({object:c});else var f=new ShaderParticleGroup({texture:c,
maxAge:d}),e=new Vizi.Visual({object:f.mesh});b.addComponent(e);a.particleGroup=f;a=new Vizi.ParticleSystemScript(a);b.addComponent(a);return b};Vizi.ParticleSystemScript=function(a){Vizi.Script.call(this,a);this.particleGroup=a.particleGroup;this._active=!0;Object.defineProperties(this,{active:{get:function(){return this._active},set:function(a){this.setActive(a)}}})};goog.inherits(Vizi.ParticleSystemScript,Vizi.Script);Vizi.ParticleSystemScript.prototype.realize=function(){this.initEmitters()};
Vizi.ParticleSystemScript.prototype.initEmitters=function(){for(var a=this._object.getComponents(Vizi.ParticleEmitter),b=0,c=a.length,b=0;b<c;b++){var d=a[b];this.particleGroup.addEmitter(d.object);d.active=this._active}this.emitters=a};Vizi.ParticleSystemScript.prototype.setActive=function(a){var b=this.emitters;if(b){for(var c=0,d=b.length,c=0;c<d;c++)b[c].active=a;this._active=a}};Vizi.ParticleSystemScript.prototype.update=function(){this.particleGroup&&this.particleGroup.tick()};
Vizi.ParticleSystem.DEFAULT_COLOR=16777215;Vizi.ParticleSystemScript.DEFAULT_MAX_AGE=1;Vizi.SpotLight=function(a){a=a||{};this.scaledDir=new THREE.Vector3;this.positionVec=new THREE.Vector3;this.castShadows=void 0!==a.castShadows?a.castShadows:Vizi.SpotLight.DEFAULT_CAST_SHADOWS;Vizi.Light.call(this,a);a.object?(this.object=a.object,this.direction=a.object.position.clone().normalize().negate(),this.targetPos=a.object.target.position.clone(),this.shadowDarkness=a.object.shadowDarkness):(this.direction=a.direction||new THREE.Vector3(0,0,-1),this.targetPos=new THREE.Vector3,this.shadowDarkness=
void 0!==a.shadowDarkness?a.shadowDarkness:Vizi.SpotLight.DEFAULT_SHADOW_DARKNESS,this.object=new THREE.SpotLight(a.color,a.intensity,void 0!==a.distance?a.distance:Vizi.SpotLight.DEFAULT_DISTANCE,void 0!==a.angle?a.angle:Vizi.SpotLight.DEFAULT_ANGLE,void 0!==a.exponent?a.exponent:Vizi.SpotLight.DEFAULT_EXPONENT));Object.defineProperties(this,{angle:{get:function(){return this.object.angle},set:function(a){this.object.angle=a}},distance:{get:function(){return this.object.distance},set:function(a){this.object.distance=
a}},exponent:{get:function(){return this.object.exponent},set:function(a){this.object.exponent=a}}})};goog.inherits(Vizi.SpotLight,Vizi.Light);Vizi.SpotLight.prototype.realize=function(){Vizi.Light.prototype.realize.call(this)};
Vizi.SpotLight.prototype.update=function(){this.object&&(this.positionVec.set(0,0,0),this.positionVec.applyMatrix4(this.object.parent.matrixWorld),this.position.copy(this.positionVec),this.scaledDir.copy(this.direction),this.scaledDir.multiplyScalar(Vizi.Light.DEFAULT_RANGE),this.targetPos.copy(this.position),this.targetPos.add(this.scaledDir),this.updateShadows());Vizi.Light.prototype.update.call(this)};
Vizi.SpotLight.prototype.updateShadows=function(){this.castShadows&&(this.object.castShadow=!0,this.object.shadowCameraNear=1,this.object.shadowCameraFar=Vizi.Light.DEFAULT_RANGE,this.object.shadowCameraFov=90,this.object.shadowBias=1E-4,this.object.shadowDarkness=this.shadowDarkness,this.object.shadowMapWidth=1024,this.object.shadowMapHeight=1024,Vizi.Graphics.instance.enableShadows(!0))};Vizi.SpotLight.DEFAULT_DISTANCE=0;Vizi.SpotLight.DEFAULT_ANGLE=Math.PI/2;Vizi.SpotLight.DEFAULT_EXPONENT=10;
Vizi.SpotLight.DEFAULT_CAST_SHADOWS=!1;Vizi.SpotLight.DEFAULT_SHADOW_DARKNESS=0.3;Vizi.Effect=function(a){Vizi.EventDispatcher.call(this);this.isShaderEffect=!1;a.render&&"function"==typeof a.render?this.pass=a:(this.pass=new THREE.ShaderPass(a),this.isShaderEffect=!0)};goog.inherits(Vizi.Effect,Vizi.EventDispatcher);Vizi.Effect.prototype.update=function(){};Vizi.Decoration=function(a){a=a||{};Vizi.Visual.call(this,a)};goog.inherits(Vizi.Decoration,Vizi.Visual);Vizi.Decoration.prototype._componentCategory="decorations";Vizi.Decoration.prototype.realize=function(){Vizi.Visual.prototype.realize.call(this);this.object.ignorePick=!0};Vizi.Modules=function(){};var CLOSURE_NO_DEPS=!0;Vizi.loadUrl=function(a,b,c){c=c||{};c.container=b;var d=new Vizi.Viewer(c);b=new Vizi.Loader;b.addEventListener("loaded",function(a){var b=e,b=(Date.now()-b)/1E3;Vizi.System.log("Vizi.loadUrl, scene loaded in ",b," seconds.");d.replaceScene(a);1<d.cameras.length&&d.useCamera(1);c.headlight&&d.setHeadlightOn(!0)});b.addEventListener("progress",function(a){Vizi.System.log("Vizi.loadUrl, ",100*(a.loaded/a.total)," % loaded.")});var e=Date.now();b.loadScene(a);d.run();return{viewer:d}};
